import React, { useState, useEffect } from 'react';
import { BookOpen, CheckCircle, XCircle, Trophy, Save, ChevronRight, Star, RefreshCcw, Edit3, ArrowLeftRight, HelpCircle } from 'lucide-react';

// --- 成語資料庫 ---
// 根據使用者提供的成語列表，依筆畫分為 6 組
// 欄位新增 synonyms (相似詞) 與 antonyms (相反詞)
const idiomDatabase = [
  // --- 第 1 組 (1-2 畫) ---
  { 
    id: 101, set: 1, word: "一言為定", zhuyin: "ㄧ ㄧㄢˊ ㄨㄟˊ ㄉㄧㄥˋ", 
    meaning: "一句話說定了，不再更改。比喻說話算數，絕不反悔。", 
    example: "我們明天去公園玩，____，誰都不許遲到。", 
    options: ["一言為定", "三心二意", "信口開河", "一知半解"],
    synonyms: ["一諾千金", "言而有信"],
    antonyms: ["出爾反爾", "食言而肥", "言而無信"]
  },
  { 
    id: 102, set: 1, word: "一知半解", zhuyin: "ㄧ ㄓ ㄅㄢˋ ㄐㄧㄝˇ", 
    meaning: "形容所知不全，了解不深。", 
    example: "這本書的內容很深奧，我讀了半天還是____。", 
    options: ["一知半解", "博古通今", "一竅不通", "融會貫通"],
    synonyms: ["略知皮毛", "管中窺豹"],
    antonyms: ["融會貫通", "博古通今", "真知灼見"]
  },
  { 
    id: 103, set: 1, word: "一鼓作氣", zhuyin: "ㄧ ㄍㄨˇ ㄗㄨㄛˋ ㄑㄧˋ", 
    meaning: "比喻做事時，趁著初起的勇氣，一舉完成。", 
    example: "大家決定____，把剩下的工作全部做完。", 
    options: ["一鼓作氣", "半途而廢", "拖泥帶水", "猶豫不決"],
    synonyms: ["打鐵趁熱", "勇往直前"],
    antonyms: ["一曝十寒", "半途而廢", "垂頭喪氣"]
  },
  { 
    id: 104, set: 1, word: "一諾千金", zhuyin: "ㄧ ㄋㄨㄛˋ ㄑㄧㄢ ㄐㄧㄣ", 
    meaning: "形容承諾信用高，一旦許諾，絕不反悔。", 
    example: "他這個人____，答應的事一定辦到。", 
    options: ["一諾千金", "信口開河", "花言巧語", "食言而肥"],
    synonyms: ["一言為定", "言而有信"],
    antonyms: ["食言而肥", "空口說白話"]
  },
  { 
    id: 105, set: 1, word: "十全十美", zhuyin: "ㄕˊ ㄑㄩㄢˊ ㄕˊ ㄇㄟˇ", 
    meaning: "比喻圓滿美好，毫無缺陷。", 
    example: "世上很難有____的事，我們盡力就好。", 
    options: ["十全十美", "一無是處", "白璧微瑕", "美中不足"],
    synonyms: ["盡善盡美", "無懈可擊"],
    antonyms: ["一無是處", "漏洞百出"]
  },

  // --- 第 2 組 (3-4 畫) ---
  { 
    id: 201, set: 2, word: "亡羊補牢", zhuyin: "ㄨㄤˊ ㄧㄤˊ ㄅㄨˇ ㄌㄠˊ", 
    meaning: "比喻犯錯後及時更正，尚能補救。", 
    example: "現在開始複習功課還來得及，____，猶未晚也。", 
    options: ["亡羊補牢", "執迷不悟", "將錯就錯", "自暴自棄"],
    synonyms: ["知錯能改"],
    antonyms: ["執迷不悟", "將錯就錯"]
  },
  { 
    id: 202, set: 2, word: "三心二意", zhuyin: "ㄙㄢ ㄒㄧㄣ ㄦˋ ㄧˋ", 
    meaning: "形容猶豫不決，意志不堅定。", 
    example: "做決定要果斷，不要____，否則什麼事都做不好。", 
    options: ["三心二意", "一心一意", "聚精會神", "專心致志"],
    synonyms: ["猶豫不決", "心猿意馬"],
    antonyms: ["一心一意", "專心致志", "聚精會神"]
  },
  { 
    id: 203, set: 2, word: "不毛之地", zhuyin: "ㄅㄨˋ ㄇㄠˊ ㄓ ㄉㄧˋ", 
    meaning: "形容荒涼貧瘠，不長草木的地方。", 
    example: "這裡曾經是____，經過開發後變成了繁榮的城市。", 
    options: ["不毛之地", "魚米之鄉", "世外桃源", "人傑地靈"],
    synonyms: ["荒山野嶺", "寸草不生"],
    antonyms: ["魚米之鄉", "沃野千里"]
  },
  { 
    id: 204, set: 2, word: "引狼入室", zhuyin: "ㄧㄣˇ ㄌㄤˊ ㄖㄨˋ ㄕˋ", 
    meaning: "比喻把壞人或敵人招引進來，自招禍患。", 
    example: "你隨便讓陌生人進家門，簡直是____。", 
    options: ["引狼入室", "拒人千里", "開門揖盜", "防微杜漸"],
    synonyms: ["開門揖盜", "認賊作父"],
    antonyms: ["拒人於千里之外"]
  },
  { 
    id: 205, set: 2, word: "五花八門", zhuyin: "ㄨˇ ㄏㄨㄚ ㄅㄚ ㄇㄣˊ", 
    meaning: "比喻花樣繁多，變化多端。", 
    example: "夜市裡賣的東西____，讓人看得眼花撩亂。", 
    options: ["五花八門", "千篇一律", "一成不變", "獨一無二"],
    synonyms: ["包羅萬象", "琳瑯滿目"],
    antonyms: ["千篇一律", "一成不變"]
  },

  // --- 第 3 組 (5-6 畫) ---
  { 
    id: 301, set: 3, word: "正大光明", zhuyin: "ㄓㄥˋ ㄉㄚˋ ㄍㄨㄤ ㄇㄧㄥˊ", 
    meaning: "形容言行正直坦蕩，公正無私。", 
    example: "我們做事____，不怕別人閒言閒語。", 
    options: ["正大光明", "鬼鬼祟祟", "偷偷摸摸", "暗箭傷人"],
    synonyms: ["光明磊落", "坦坦蕩蕩"],
    antonyms: ["鬼鬼祟祟", "心懷鬼胎"]
  },
  { 
    id: 302, set: 3, word: "生龍活虎", zhuyin: "ㄕㄥ ㄌㄨㄥˊ ㄏㄨㄛˊ ㄏㄨˇ", 
    meaning: "形容活潑矯健，生氣勃勃。", 
    example: "休息過後，他又是一條____的好漢。", 
    options: ["生龍活虎", "死氣沉沉", "半死不活", "奄奄一息"],
    synonyms: ["精神奕奕", "龍精虎猛"],
    antonyms: ["死氣沉沉", "萎靡不振", "垂頭喪氣"]
  },
  { 
    id: 303, set: 3, word: "自相矛盾", zhuyin: "ㄗˋ ㄒㄧㄤ ㄇㄠˊ ㄉㄨㄣˋ", 
    meaning: "比喻言語或行事前後不一致。", 
    example: "你剛才說要去，現在又說不去，這不是____嗎？", 
    options: ["自相矛盾", "言行一致", "表裡如一", "心口如一"],
    synonyms: ["前後不一", "漏洞百出"],
    antonyms: ["言行一致", "表裡如一"]
  },
  { 
    id: 304, set: 3, word: "因材施教", zhuyin: "ㄧㄣ ㄘㄞˊ ㄕ ㄐㄧㄠˋ", 
    meaning: "依據學生的資質、才幹，給予適當的教育。", 
    example: "老師懂得____，讓每個學生都能發揮專長。", 
    options: ["因材施教", "一視同仁", "拔苗助長", "對牛彈琴"],
    synonyms: ["量體裁衣"],
    antonyms: ["一視同仁", "千篇一律"]
  },
  { 
    id: 305, set: 3, word: "自投羅網", zhuyin: "ㄗˋ ㄊㄡˊ ㄌㄨㄛˊ ㄨㄤˇ", 
    meaning: "比喻落入圈套或自取災禍。", 
    example: "壞人以為這裡安全，結果卻是____，被警察抓個正著。", 
    options: ["自投羅網", "逃之夭夭", "全身而退", "明哲保身"],
    synonyms: ["飛蛾撲火", "作繭自縛"],
    antonyms: ["逃之夭夭", "全身而退"]
  },

  // --- 第 4 組 (7-8 畫) ---
  { 
    id: 401, set: 4, word: "呆若木雞", zhuyin: "ㄉㄞ ㄖㄨㄛˋ ㄇㄨˋ ㄐㄧ", 
    meaning: "形容因驚恐或驚訝而發愣的樣子。", 
    example: "聽到這個驚人的消息，他整個人____，說不出話來。", 
    options: ["呆若木雞", "神采飛揚", "談笑風生", "泰然自若"],
    synonyms: ["目瞪口呆", "瞠目結舌"],
    antonyms: ["神采飛揚", "從容不迫"]
  },
  { 
    id: 402, set: 4, word: "花言巧語", zhuyin: "ㄏㄨㄚ ㄧㄢˊ ㄑㄧㄠˇ ㄩˇ", 
    meaning: "形容虛假而動聽的言語。", 
    example: "不要相信詐騙集團的____，以免上當受騙。", 
    options: ["花言巧語", "忠言逆耳", "金玉良言", "肺腑之言"],
    synonyms: ["甜言蜜語", "口蜜腹劍"],
    antonyms: ["肺腑之言", "忠言逆耳", "金玉良言"]
  },
  { 
    id: 403, set: 4, word: "表裡如一", zhuyin: "ㄅㄧㄠˇ ㄌㄧˇ ㄖㄨˊ ㄧ", 
    meaning: "指外表和內心一致。", 
    example: "他是一個____的君子，絕對不會在背後說人壞話。", 
    options: ["表裡如一", "口是心非", "兩面三刀", "陽奉陰違"],
    synonyms: ["言行一致", "誠心誠意"],
    antonyms: ["口是心非", "表裡不一", "笑裡藏刀"]
  },
  { 
    id: 404, set: 4, word: "柳暗花明", zhuyin: "ㄌㄧㄡˇ ㄢˋ ㄏㄨㄚ ㄇㄧㄥˊ", 
    meaning: "比喻在絕望中產生轉機。", 
    example: "只要不放棄，事情總會有____的一天。", 
    options: ["柳暗花明", "山窮水盡", "走投無路", "日暮途窮"],
    synonyms: ["峰迴路轉", "絕處逢生"],
    antonyms: ["山窮水盡", "走投無路"]
  },
  { 
    id: 405, set: 4, word: "垂頭喪氣", zhuyin: "ㄔㄨㄟˊ ㄊㄡˊ ㄙㄤˋ ㄑㄧˋ", 
    meaning: "形容失意沮喪的樣子。", 
    example: "比賽輸了，隊員們個個____。", 
    options: ["垂頭喪氣", "趾高氣揚", "得意洋洋", "意氣風發"],
    synonyms: ["灰心喪氣", "無精打采"],
    antonyms: ["趾高氣揚", "神采飛揚", "意氣風發"]
  },

  // --- 第 5 組 (9-10 畫) ---
  { 
    id: 501, set: 5, word: "害群之馬", zhuyin: "ㄏㄞˋ ㄑㄩㄣˊ ㄓ ㄇㄚˇ", 
    meaning: "比喻危害群體的人。", 
    example: "我們要遵守班規，不要當____。", 
    options: ["害群之馬", "棟樑之才", "中流砥柱", "人中之龍"],
    synonyms: ["群蟻附羶"],
    antonyms: ["棟樑之才", "中流砥柱"]
  },
  { 
    id: 502, set: 5, word: "捕風捉影", zhuyin: "ㄅㄨˇ ㄈㄥ ㄓㄨㄛ ㄧㄥˇ", 
    meaning: "比喻說話或做事沒有事實根據。", 
    example: "這件事純屬____的謠言，大家不要相信。", 
    options: ["捕風捉影", "實事求是", "證據確鑿", "鐵證如山"],
    synonyms: ["無中生有", "空穴來風"],
    antonyms: ["實事求是", "鐵證如山"]
  },
  { 
    id: 503, set: 5, word: "挺身而出", zhuyin: "ㄊㄧㄥˇ ㄕㄣ ㄦˊ ㄔㄨ", 
    meaning: "遇到危難或責任時，勇敢地站出來。", 
    example: "看到有人被欺負，他立刻____主持公道。", 
    options: ["挺身而出", "袖手旁觀", "畏縮不前", "置身事外"],
    synonyms: ["自告奮勇", "見義勇為"],
    antonyms: ["袖手旁觀", "畏縮不前", "明哲保身"]
  },
  { 
    id: 504, set: 5, word: "得心應手", zhuyin: "ㄉㄜˊ ㄒㄧㄣ ㄧㄥˋ ㄕㄡˇ", 
    meaning: "形容技藝熟練，運用自如。", 
    example: "他彈鋼琴已經到了____的境界。", 
    options: ["得心應手", "手忙腳亂", "力不從心", "笨手笨腳"],
    synonyms: ["運用自如", "駕輕就熟"],
    antonyms: ["手忙腳亂", "力不從心", "束手無策"]
  },
  { 
    id: 505, set: 5, word: "頂天立地", zhuyin: "ㄉㄧㄥˇ ㄊㄧㄢ ㄌㄧˋ ㄉㄧˋ", 
    meaning: "形容人氣概豪邁，光明正大。", 
    example: "做人要____，仰不愧於天，俯不怍於人。", 
    options: ["頂天立地", "卑躬屈膝", "奴顏婢膝", "唯唯諾諾"],
    synonyms: ["光明磊落"],
    antonyms: ["卑躬屈膝", "奴顏婢膝"]
  },

  // --- 第 6 組 (11-12 畫) ---
  { 
    id: 601, set: 6, word: "喜出望外", zhuyin: "ㄒㄧˇ ㄔㄨ ㄨㄤˋ ㄨㄞˋ", 
    meaning: "因意想不到的喜事而特別高興。", 
    example: "聽到中了頭獎的消息，他簡直____。", 
    options: ["喜出望外", "大失所望", "悲痛欲絕", "心如死灰"],
    synonyms: ["大喜過望", "欣喜若狂"],
    antonyms: ["大失所望", "悲痛欲絕", "晴天霹靂"]
  },
  { 
    id: 602, set: 6, word: "揚眉吐氣", zhuyin: "ㄧㄤˊ ㄇㄟˊ ㄊㄨˇ ㄑㄧˋ", 
    meaning: "形容擺脫壓抑心情後的興奮神情。", 
    example: "這次比賽奪冠，終於讓他____了。", 
    options: ["揚眉吐氣", "垂頭喪氣", "忍氣吞聲", "委曲求全"],
    synonyms: ["意氣風發"],
    antonyms: ["垂頭喪氣", "忍氣吞聲", "愁眉苦臉"]
  },
  { 
    id: 603, set: 6, word: "毫不氣餒", zhuyin: "ㄏㄠˊ ㄅㄨˋ ㄑㄧˋ ㄋㄟˇ", 
    meaning: "一點也不喪失勇氣。", 
    example: "雖然失敗了很多次，但他____，繼續努力。", 
    options: ["毫不氣餒", "心灰意冷", "半途而廢", "一蹶不振"],
    synonyms: ["再接再厲", "百折不撓"],
    antonyms: ["心灰意冷", "一蹶不振"]
  },
  { 
    id: 604, set: 6, word: "凱旋而歸", zhuyin: "ㄎㄞˇ ㄒㄩㄢˊ ㄦˊ ㄍㄨㄟ", 
    meaning: "獲勝歸來。", 
    example: "戰士們打贏了勝仗，____。", 
    options: ["凱旋而歸", "鎩羽而歸", "全軍覆沒", "大敗而逃"],
    synonyms: ["滿載而歸", "班師回朝"],
    antonyms: ["鎩羽而歸", "全軍覆沒", "一敗塗地"]
  },
  { 
    id: 605, set: 6, word: "富可敵國", zhuyin: "ㄈㄨˋ ㄎㄜˇ ㄉㄧˊ ㄍㄨㄛˊ", 
    meaning: "形容極為富有。", 
    example: "傳說這位商人的財富____，令人羨慕。", 
    options: ["富可敵國", "一貧如洗", "家徒四壁", "身無分文"],
    synonyms: ["腰纏萬貫", "揮金如土"],
    antonyms: ["一貧如洗", "家徒四壁", "兩袖清風"]
  },
];

// --- Google Apps Script Web App URL (預設為空，由老師輸入) ---
const DEFAULT_SCRIPT_URL = ""; 

export default function IdiomLearningApp() {
  const [view, setView] = useState('home'); // home, sets, activities, practice, result
  const [currentSet, setCurrentSet] = useState(1);
  const [activityType, setActivityType] = useState('learn'); // learn, quiz_meaning, quiz_synonym_antonym, fill_blank, comprehensive
  const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);
  const [score, setScore] = useState(0);
  const [answersLog, setAnswersLog] = useState([]); // 記錄答題過程
  const [feedback, setFeedback] = useState(null); // correct, wrong
  const [studentName, setStudentName] = useState("");
  const [scriptUrl, setScriptUrl] = useState(DEFAULT_SCRIPT_URL);
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [submitStatus, setSubmitStatus] = useState(null);

  // 根據選擇的 Set 過濾資料
  const getSetData = () => {
    return idiomDatabase.filter(item => item.set === currentSet);
  };

  // 重置練習
  const startPractice = (type) => {
    setActivityType(type);
    setCurrentQuestionIndex(0);
    setScore(0);
    setAnswersLog([]);
    setFeedback(null);
    setSubmitStatus(null);
    setView('practice');
  };

  // 處理答題
  const handleAnswer = (selectedOption, correctOption, questionData, questionText) => {
    const isCorrect = selectedOption === correctOption;
    
    // 記錄詳細過程
    const logEntry = {
      question: questionText || questionData.word,
      type: activityType,
      userAnswer: selectedOption,
      correctAnswer: correctOption,
      isCorrect: isCorrect,
      timestamp: new Date().toISOString()
    };
    
    setAnswersLog([...answersLog, logEntry]);

    if (isCorrect) {
      setScore(score + 10); // 每題 10 分
      setFeedback('correct');
    } else {
      setFeedback('wrong');
    }

    // 延遲後進入下一題
    setTimeout(() => {
      setFeedback(null);
      if (currentQuestionIndex < getSetData().length - 1) {
        setCurrentQuestionIndex(currentQuestionIndex + 1);
      } else {
        setView('result');
      }
    }, 1500);
  };

  // 上傳成績到 Google Sheets
  const submitToGoogle = async () => {
    if (!scriptUrl) {
      alert("請先設定 Google Apps Script 網址！");
      return;
    }
    if (!studentName) {
      alert("請輸入姓名！");
      return;
    }

    setIsSubmitting(true);
    
    const payload = {
      studentName: studentName,
      set: currentSet,
      mode: activityType,
      score: score,
      totalQuestions: getSetData().length,
      timestamp: new Date().toLocaleString(),
      details: JSON.stringify(answersLog.map(a => `${a.question.substring(0, 10)}...(${a.isCorrect?'O':'X'})`))
    };

    try {
      await fetch(scriptUrl, {
        method: 'POST',
        mode: 'no-cors',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(payload)
      });
      setSubmitStatus('success');
    } catch (error) {
      console.error(error);
      setSubmitStatus('error');
    } finally {
      setIsSubmitting(false);
    }
  };

  // --- UI Components ---

  const renderHome = () => (
    <div className="flex flex-col items-center justify-center h-full space-y-8 p-6 bg-gradient-to-b from-blue-100 to-blue-50">
      <h1 className="text-5xl font-bold text-blue-600 tracking-wider mb-4 drop-shadow-sm">成語探險家</h1>
      <div className="text-xl text-gray-600 mb-8">國小五年級 - 互動練習平台</div>
      <div className="bg-white p-6 rounded-2xl shadow-xl w-full max-w-md">
        <label className="block text-gray-700 font-bold mb-2">我是...</label>
        <input 
          type="text" 
          placeholder="請輸入你的名字" 
          className="w-full p-3 border-2 border-blue-200 rounded-xl text-lg focus:border-blue-500 focus:outline-none transition"
          value={studentName}
          onChange={(e) => setStudentName(e.target.value)}
        />
      </div>
      <button 
        onClick={() => {
          if(!studentName) {
            alert("請先輸入名字喔！");
            return;
          }
          setView('sets');
        }}
        className="px-10 py-4 bg-blue-500 hover:bg-blue-600 text-white text-2xl font-bold rounded-full shadow-lg transform transition hover:scale-105 flex items-center gap-2"
      >
        開始冒險 <ChevronRight />
      </button>
      
      {/* 老師設定區 (隱藏式) */}
      <div className="mt-12 text-xs text-gray-400 w-full max-w-md">
        <details>
          <summary>老師設定 (Google Sheet URL)</summary>
          <input 
            type="text" 
            value={scriptUrl} 
            onChange={(e) => setScriptUrl(e.target.value)}
            className="w-full p-2 border mt-2 rounded"
            placeholder="https://script.google.com/macros/s/AKfycbyoFfvC-xeLlAcfG2uI-cGUdm7YFVKJyGO7NEiekYOYIWJLEMDUBPIh83QjKwHQyJjs-g/exec"
          />
        </details>
      </div>
    </div>
  );

  const renderSetSelection = () => (
    <div className="p-6 bg-blue-50 min-h-screen">
      <button onClick={() => setView('home')} className="mb-4 text-blue-500 font-bold">← 回首頁</button>
      <h2 className="text-3xl font-bold text-center text-blue-800 mb-8">選擇挑戰關卡</h2>
      <div className="grid grid-cols-2 md:grid-cols-3 gap-6 max-w-4xl mx-auto">
        {[1, 2, 3, 4, 5, 6].map((setNum) => (
          <button
            key={setNum}
            onClick={() => {
              setCurrentSet(setNum);
              setView('activities');
            }}
            className="h-40 bg-white rounded-2xl shadow-md hover:shadow-xl hover:bg-blue-50 transition border-b-4 border-blue-200 hover:border-blue-400 flex flex-col items-center justify-center gap-2"
          >
            <span className="text-4xl font-black text-blue-300">0{setNum}</span>
            <span className="text-xl font-bold text-gray-700">第 {setNum} 練習</span>
            <span className="text-sm text-gray-500">適合筆畫: {setNum * 2 - 1}~{setNum * 2} 畫</span>
          </button>
        ))}
      </div>
    </div>
  );

  const renderActivitySelection = () => (
    <div className="p-6 bg-indigo-50 min-h-screen flex flex-col items-center">
      <button onClick={() => setView('sets')} className="self-start mb-4 text-indigo-500 font-bold">← 回關卡選單</button>
      <h2 className="text-3xl font-bold text-indigo-800 mb-2">第 {currentSet} 練習：選擇模式</h2>
      <p className="text-gray-500 mb-8">準備好要挑戰什麼了嗎？</p>
      
      <div className="grid grid-cols-1 md:grid-cols-2 gap-4 w-full max-w-3xl">
        <ActivityCard 
          icon={<BookOpen size={32}/>} 
          title="成語解釋 (學習)" 
          desc="先來認識這些成語的意思和注音吧！" 
          color="bg-green-100 text-green-700 border-green-300"
          onClick={() => startPractice('learn')}
        />
        <ActivityCard 
          icon={<Star size={32}/>} 
          title="選出正確答案" 
          desc="根據解釋，選出正確的成語。" 
          color="bg-yellow-100 text-yellow-700 border-yellow-300"
          onClick={() => startPractice('quiz_meaning')}
        />
        <ActivityCard 
          icon={<ArrowLeftRight size={32}/>} 
          title="相似/相反詞挑戰" 
          desc="這個成語跟誰意思相近或相反？" 
          color="bg-purple-100 text-purple-700 border-purple-300"
          onClick={() => startPractice('quiz_synonym_antonym')}
        />
        <ActivityCard 
          icon={<Edit3 size={32}/>} 
          title="靈活運用 (填空)" 
          desc="讀例句，把適合的成語填進去。" 
          color="bg-pink-100 text-pink-700 border-pink-300"
          onClick={() => startPractice('fill_blank')}
        />
        <ActivityCard 
          icon={<Trophy size={32}/>} 
          title="綜合大測驗" 
          desc="包含解釋、填空與相似相反詞題型！" 
          color="bg-blue-100 text-blue-700 border-blue-300 col-span-1 md:col-span-2"
          onClick={() => startPractice('comprehensive')}
        />
      </div>
    </div>
  );

  const renderPractice = () => {
    const questions = getSetData();
    const currentQ = questions[currentQuestionIndex];
    
    // 學習模式
    if (activityType === 'learn') {
      return (
        <div className="flex flex-col items-center justify-center min-h-screen bg-green-50 p-6">
          <div className="bg-white rounded-3xl shadow-xl p-8 max-w-2xl w-full text-center relative overflow-hidden">
             <div className="absolute top-0 left-0 w-full h-4 bg-green-400"></div>
             <span className="text-gray-400 text-sm font-bold tracking-widest uppercase mb-2 block">Card {currentQuestionIndex + 1} / {questions.length}</span>
             
             <h1 className="text-6xl font-black text-gray-800 mb-4">{currentQ.word}</h1>
             <div className="text-3xl text-green-600 font-serif mb-8">{currentQ.zhuyin}</div>
             
             <div className="bg-green-50 rounded-xl p-6 mb-4 text-left">
               <h3 className="font-bold text-green-800 mb-2">【解釋】</h3>
               <p className="text-xl text-gray-700">{currentQ.meaning}</p>
             </div>

             <div className="bg-blue-50 rounded-xl p-6 text-left border-l-4 border-blue-400 mb-4">
               <h3 className="font-bold text-blue-800 mb-2">【例句】</h3>
               <p className="text-lg text-gray-700">{currentQ.example.replace('____', currentQ.word)}</p>
             </div>

             <div className="grid grid-cols-2 gap-4 text-sm">
                <div className="bg-purple-50 p-2 rounded text-purple-800 text-left">
                  <span className="font-bold">相似詞：</span>{currentQ.synonyms?.join("、") || "無"}
                </div>
                <div className="bg-red-50 p-2 rounded text-red-800 text-left">
                  <span className="font-bold">相反詞：</span>{currentQ.antonyms?.join("、") || "無"}
                </div>
             </div>

             <div className="mt-8 flex justify-between">
                <button 
                  disabled={currentQuestionIndex === 0}
                  onClick={() => setCurrentQuestionIndex(c => c - 1)}
                  className="px-6 py-2 rounded-lg bg-gray-200 text-gray-600 disabled:opacity-50"
                >
                  上一個
                </button>
                {currentQuestionIndex < questions.length - 1 ? (
                  <button 
                    onClick={() => setCurrentQuestionIndex(c => c + 1)}
                    className="px-6 py-2 rounded-lg bg-green-500 text-white font-bold hover:bg-green-600"
                  >
                    下一個
                  </button>
                ) : (
                  <button 
                    onClick={() => setView('activities')}
                    className="px-6 py-2 rounded-lg bg-blue-600 text-white font-bold hover:bg-blue-700"
                  >
                    完成學習
                  </button>
                )}
             </div>
          </div>
        </div>
      );
    }

    // 測驗模式邏輯
    let questionText = "";
    let options = [];
    let correctAnswer = "";

    // Helper: 產生隨機錯誤選項 (從同組題目中撈，避免重複)
    const getDistractors = (excludeWord, count = 3) => {
        const others = questions.filter(q => q.word !== excludeWord).map(q => q.word);
        return others.sort(() => Math.random() - 0.5).slice(0, count);
    };

    if (activityType === 'quiz_meaning') {
      questionText = `「${currentQ.meaning}」 是哪一個成語？`;
      correctAnswer = currentQ.word;
      options = currentQ.options; 
    } 
    else if (activityType === 'quiz_synonym_antonym') {
        // 隨機決定考相似還是相反 (如果有資料的話)
        const hasSyn = currentQ.synonyms && currentQ.synonyms.length > 0;
        const hasAnt = currentQ.antonyms && currentQ.antonyms.length > 0;
        
        let type = 'syn'; // default
        if (hasSyn && hasAnt) type = Math.random() > 0.5 ? 'syn' : 'ant';
        else if (hasAnt) type = 'ant';

        if (type === 'syn') {
            const answer = currentQ.synonyms[0]; // 取第一個相似詞當答案
            correctAnswer = answer;
            questionText = `下列哪一個是「${currentQ.word}」的相似詞？`;
            // 混淆選項：優先放相反詞，不夠再放其他成語
            let distractors = currentQ.antonyms ? [...currentQ.antonyms] : [];
            if(distractors.length < 3) {
                distractors = [...distractors, ...getDistractors(currentQ.word, 3 - distractors.length)];
            }
            options = [answer, ...distractors.slice(0,3)].sort(() => Math.random() - 0.5);
        } else {
            const answer = currentQ.antonyms[0];
            correctAnswer = answer;
            questionText = `下列哪一個是「${currentQ.word}」的相反詞？`;
            // 混淆選項：優先放相似詞
            let distractors = currentQ.synonyms ? [...currentQ.synonyms] : [];
            if(distractors.length < 3) {
                distractors = [...distractors, ...getDistractors(currentQ.word, 3 - distractors.length)];
            }
            options = [answer, ...distractors.slice(0,3)].sort(() => Math.random() - 0.5);
        }
    }
    else if (activityType === 'fill_blank') {
      questionText = currentQ.example;
      correctAnswer = currentQ.word;
      options = currentQ.options;
    } 
    else if (activityType === 'comprehensive') {
        // 綜合測驗：隨機混和題型
        const seed = (currentQuestionIndex + score) % 3; // 簡易偽隨機
        if(seed === 0) {
            // Meaning
            questionText = `「${currentQ.meaning}」 是哪一個成語？`;
            correctAnswer = currentQ.word;
            options = currentQ.options;
        } else if (seed === 1) {
            // Fill blank
            questionText = currentQ.example;
            correctAnswer = currentQ.word;
            options = currentQ.options;
        } else {
            // Syn/Ant logic copied from above
             const hasSyn = currentQ.synonyms && currentQ.synonyms.length > 0;
             const hasAnt = currentQ.antonyms && currentQ.antonyms.length > 0;
             let type = 'syn'; 
             if (hasSyn && hasAnt) type = Math.random() > 0.5 ? 'syn' : 'ant';
             else if (hasAnt) type = 'ant';

             if (type === 'syn') {
                 correctAnswer = currentQ.synonyms[0];
                 questionText = `下列哪一個是「${currentQ.word}」的相似詞？`;
                 let distractors = currentQ.antonyms ? [...currentQ.antonyms] : [];
                 if(distractors.length < 3) distractors = [...distractors, ...getDistractors(currentQ.word, 3 - distractors.length)];
                 options = [correctAnswer, ...distractors.slice(0,3)].sort(() => Math.random() - 0.5);
             } else {
                 correctAnswer = currentQ.antonyms[0];
                 questionText = `下列哪一個是「${currentQ.word}」的相反詞？`;
                 let distractors = currentQ.synonyms ? [...currentQ.synonyms] : [];
                 if(distractors.length < 3) distractors = [...distractors, ...getDistractors(currentQ.word, 3 - distractors.length)];
                 options = [correctAnswer, ...distractors.slice(0,3)].sort(() => Math.random() - 0.5);
             }
        }
    }

    return (
      <div className="flex flex-col items-center min-h-screen bg-yellow-50 p-4">
        {/* 進度條 */}
        <div className="w-full max-w-2xl h-4 bg-gray-200 rounded-full mb-6 overflow-hidden">
          <div 
            className="h-full bg-yellow-400 transition-all duration-500 ease-out"
            style={{ width: `${((currentQuestionIndex) / questions.length) * 100}%` }}
          ></div>
        </div>

        <div className="bg-white rounded-2xl shadow-lg p-8 max-w-2xl w-full text-center relative">
          {feedback === 'correct' && (
             <div className="absolute inset-0 bg-green-100 bg-opacity-90 rounded-2xl flex flex-col items-center justify-center z-10 animate-fade-in">
                <CheckCircle size={80} className="text-green-500 mb-4" />
                <span className="text-4xl font-black text-green-600">答對了！</span>
             </div>
          )}
          {feedback === 'wrong' && (
             <div className="absolute inset-0 bg-red-100 bg-opacity-90 rounded-2xl flex flex-col items-center justify-center z-10 animate-fade-in">
                <XCircle size={80} className="text-red-500 mb-4" />
                <span className="text-4xl font-black text-red-600">再試一次！</span>
             </div>
          )}

          <h2 className="text-lg text-gray-500 font-bold mb-6 flex items-center justify-center gap-2">
            題目 {currentQuestionIndex + 1} / {questions.length} 
            {activityType === 'comprehensive' && <span className="bg-blue-100 text-blue-600 text-xs px-2 py-1 rounded">綜合挑戰</span>}
          </h2>
          
          <div className="text-2xl font-bold text-gray-800 mb-10 leading-relaxed min-h-[100px] flex items-center justify-center px-4">
            {questionText}
          </div>

          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            {options.map((opt, idx) => (
              <button
                key={idx}
                onClick={() => handleAnswer(opt, correctAnswer, currentQ, questionText)}
                className="p-4 rounded-xl border-2 border-gray-100 bg-gray-50 hover:bg-yellow-100 hover:border-yellow-300 text-xl font-bold text-gray-700 transition active:scale-95"
              >
                {opt}
              </button>
            ))}
          </div>
        </div>
        <div className="mt-8 text-xl font-bold text-yellow-600">目前分數：{score}</div>
      </div>
    );
  };

  const renderResult = () => (
    <div className="flex flex-col items-center justify-center min-h-screen bg-purple-50 p-6">
      <div className="bg-white p-10 rounded-3xl shadow-2xl text-center max-w-lg w-full">
        <Trophy size={80} className="mx-auto text-yellow-400 mb-6" />
        <h2 className="text-4xl font-black text-gray-800 mb-2">練習完成！</h2>
        <p className="text-xl text-gray-500 mb-8">{studentName}，你真棒！</p>
        
        <div className="bg-purple-100 rounded-xl p-6 mb-8">
          <span className="block text-sm text-purple-600 font-bold uppercase tracking-wider">Total Score</span>
          <span className="text-6xl font-black text-purple-700">{score}</span>
          <span className="text-purple-400 text-xl"> / {getSetData().length * 10} 分</span>
        </div>

        <div className="space-y-3">
          <button 
            onClick={submitToGoogle}
            disabled={isSubmitting || submitStatus === 'success'}
            className={`w-full py-4 rounded-xl font-bold text-xl flex items-center justify-center gap-2 transition ${
              submitStatus === 'success' 
                ? 'bg-green-500 text-white cursor-default' 
                : 'bg-blue-600 text-white hover:bg-blue-700 shadow-lg hover:shadow-xl'
            }`}
          >
            {isSubmitting ? <RefreshCcw className="animate-spin"/> : <Save />}
            {submitStatus === 'success' ? '成績已儲存' : '儲存成績'}
          </button>

          <button 
            onClick={() => setView('sets')}
            className="w-full py-4 rounded-xl font-bold text-xl text-gray-600 bg-gray-100 hover:bg-gray-200 transition"
          >
            練習其他關卡
          </button>
        </div>
        
        {submitStatus === 'error' && (
             <p className="text-red-500 mt-2 text-sm">儲存失敗，請檢查網路或通知老師。</p>
        )}
      </div>
    </div>
  );

  const ActivityCard = ({ icon, title, desc, color, onClick }) => (
    <button 
      onClick={onClick}
      className={`p-6 rounded-2xl border-b-4 text-left transition hover:-translate-y-1 hover:shadow-lg flex items-start gap-4 ${color}`}
    >
      <div className="p-2 bg-white bg-opacity-50 rounded-lg">{icon}</div>
      <div>
        <h3 className="text-xl font-bold mb-1">{title}</h3>
        <p className="text-sm opacity-90">{desc}</p>
      </div>
    </button>
  );

  // Main View Switcher
  switch (view) {
    case 'home': return renderHome();
    case 'sets': return renderSetSelection();
    case 'activities': return renderActivitySelection();
    case 'practice': return renderPractice();
    case 'result': return renderResult();
    default: return renderHome();
  }
}
