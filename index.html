<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>成語探險家 - 小五互動練習</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        .animate-fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .btn-hover:active {
            transform: scale(0.95);
        }
        
        /* 隱藏捲軸但保留功能 */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body class="bg-blue-50 text-gray-800 min-h-screen">

    <!-- 應用程式容器 -->
    <div id="app" class="min-h-screen flex flex-col">
        <!-- 內容將由 JavaScript 動態渲染 -->
    </div>

    <script>
        // --- 1. SVG 圖示庫 (用字串存儲以保持單一檔案) ---
        const Icons = {
            ChevronRight: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>`,
            BookOpen: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>`,
            Star: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>`,
            ArrowLeftRight: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3 4 7l4 4"/><path d="M4 7h16"/><path d="m16 21 4-4-4-4"/><path d="M20 17H4"/></svg>`,
            Edit3: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"/></svg>`,
            Trophy: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>`,
            CheckCircle: `<svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>`,
            XCircle: `<svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>`,
            Save: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>`,
            Refresh: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 2v6h-6"/><path d="M3 12a9 9 0 0 1 15-6.7L21 8"/><path d="M3 22v-6h6"/><path d="M21 12a9 9 0 0 1-15 6.7L3 16"/></svg>`
        };

        // --- 2. 成語資料庫 ---
        const idiomDatabase = [
          // --- 第 1 組 (1-2 畫) ---
          { 
            id: 101, set: 1, word: "一言為定", zhuyin: "ㄧ ㄧㄢˊ ㄨㄟˊ ㄉㄧㄥˋ", 
            meaning: "一句話說定了，不再更改。比喻說話算數，絕不反悔。", 
            example: "我們明天去公園玩，____，誰都不許遲到。", 
            options: ["一言為定", "三心二意", "信口開河", "一知半解"],
            synonyms: ["一諾千金", "言而有信"],
            antonyms: ["出爾反爾", "食言而肥", "言而無信"]
          },
          { 
            id: 102, set: 1, word: "一知半解", zhuyin: "ㄧ ㄓ ㄅㄢˋ ㄐㄧㄝˇ", 
            meaning: "形容所知不全，了解不深。", 
            example: "這本書的內容很深奧，我讀了半天還是____。", 
            options: ["一知半解", "博古通今", "一竅不通", "融會貫通"],
            synonyms: ["略知皮毛", "管中窺豹"],
            antonyms: ["融會貫通", "博古通今", "真知灼見"]
          },
          { 
            id: 103, set: 1, word: "一鼓作氣", zhuyin: "ㄧ ㄍㄨˇ ㄗㄨㄛˋ ㄑㄧˋ", 
            meaning: "比喻做事時，趁著初起的勇氣，一舉完成。", 
            example: "大家決定____，把剩下的工作全部做完。", 
            options: ["一鼓作氣", "半途而廢", "拖泥帶水", "猶豫不決"],
            synonyms: ["打鐵趁熱", "勇往直前"],
            antonyms: ["一曝十寒", "半途而廢", "垂頭喪氣"]
          },
          { 
            id: 104, set: 1, word: "一諾千金", zhuyin: "ㄧ ㄋㄨㄛˋ ㄑㄧㄢ ㄐㄧㄣ", 
            meaning: "形容承諾信用高，一旦許諾，絕不反悔。", 
            example: "他這個人____，答應的事一定辦到。", 
            options: ["一諾千金", "信口開河", "花言巧語", "食言而肥"],
            synonyms: ["一言為定", "言而有信"],
            antonyms: ["食言而肥", "空口說白話"]
          },
          { 
            id: 105, set: 1, word: "十全十美", zhuyin: "ㄕˊ ㄑㄩㄢˊ ㄕˊ ㄇㄟˇ", 
            meaning: "比喻圓滿美好，毫無缺陷。", 
            example: "世上很難有____的事，我們盡力就好。", 
            options: ["十全十美", "一無是處", "白璧微瑕", "美中不足"],
            synonyms: ["盡善盡美", "無懈可擊"],
            antonyms: ["一無是處", "漏洞百出"]
          },

          // --- 第 2 組 (3-4 畫) ---
          { 
            id: 201, set: 2, word: "亡羊補牢", zhuyin: "ㄨㄤˊ ㄧㄤˊ ㄅㄨˇ ㄌㄠˊ", 
            meaning: "比喻犯錯後及時更正，尚能補救。", 
            example: "現在開始複習功課還來得及，____，猶未晚也。", 
            options: ["亡羊補牢", "執迷不悟", "將錯就錯", "自暴自棄"],
            synonyms: ["知錯能改"],
            antonyms: ["執迷不悟", "將錯就錯"]
          },
          { 
            id: 202, set: 2, word: "三心二意", zhuyin: "ㄙㄢ ㄒㄧㄣ ㄦˋ ㄧˋ", 
            meaning: "形容猶豫不決，意志不堅定。", 
            example: "做決定要果斷，不要____，否則什麼事都做不好。", 
            options: ["三心二意", "一心一意", "聚精會神", "專心致志"],
            synonyms: ["猶豫不決", "心猿意馬"],
            antonyms: ["一心一意", "專心致志", "聚精會神"]
          },
          { 
            id: 203, set: 2, word: "不毛之地", zhuyin: "ㄅㄨˋ ㄇㄠˊ ㄓ ㄉㄧˋ", 
            meaning: "形容荒涼貧瘠，不長草木的地方。", 
            example: "這裡曾經是____，經過開發後變成了繁榮的城市。", 
            options: ["不毛之地", "魚米之鄉", "世外桃源", "人傑地靈"],
            synonyms: ["荒山野嶺", "寸草不生"],
            antonyms: ["魚米之鄉", "沃野千里"]
          },
          { 
            id: 204, set: 2, word: "引狼入室", zhuyin: "ㄧㄣˇ ㄌㄤˊ ㄖㄨˋ ㄕˋ", 
            meaning: "比喻把壞人或敵人招引進來，自招禍患。", 
            example: "你隨便讓陌生人進家門，簡直是____。", 
            options: ["引狼入室", "拒人千里", "開門揖盜", "防微杜漸"],
            synonyms: ["開門揖盜", "認賊作父"],
            antonyms: ["拒人於千里之外"]
          },
          { 
            id: 205, set: 2, word: "五花八門", zhuyin: "ㄨˇ ㄏㄨㄚ ㄅㄚ ㄇㄣˊ", 
            meaning: "比喻花樣繁多，變化多端。", 
            example: "夜市裡賣的東西____，讓人看得眼花撩亂。", 
            options: ["五花八門", "千篇一律", "一成不變", "獨一無二"],
            synonyms: ["包羅萬象", "琳瑯滿目"],
            antonyms: ["千篇一律", "一成不變"]
          },

          // --- 第 3 組 (5-6 畫) ---
          { 
            id: 301, set: 3, word: "正大光明", zhuyin: "ㄓㄥˋ ㄉㄚˋ ㄍㄨㄤ ㄇㄧㄥˊ", 
            meaning: "形容言行正直坦蕩，公正無私。", 
            example: "我們做事____，不怕別人閒言閒語。", 
            options: ["正大光明", "鬼鬼祟祟", "偷偷摸摸", "暗箭傷人"],
            synonyms: ["光明磊落", "坦坦蕩蕩"],
            antonyms: ["鬼鬼祟祟", "心懷鬼胎"]
          },
          { 
            id: 302, set: 3, word: "生龍活虎", zhuyin: "ㄕㄥ ㄌㄨㄥˊ ㄏㄨㄛˊ ㄏㄨˇ", 
            meaning: "形容活潑矯健，生氣勃勃。", 
            example: "休息過後，他又是一條____的好漢。", 
            options: ["生龍活虎", "死氣沉沉", "半死不活", "奄奄一息"],
            synonyms: ["精神奕奕", "龍精虎猛"],
            antonyms: ["死氣沉沉", "萎靡不振", "垂頭喪氣"]
          },
          { 
            id: 303, set: 3, word: "自相矛盾", zhuyin: "ㄗˋ ㄒㄧㄤ ㄇㄠˊ ㄉㄨㄣˋ", 
            meaning: "比喻言語或行事前後不一致。", 
            example: "你剛才說要去，現在又說不去，這不是____嗎？", 
            options: ["自相矛盾", "言行一致", "表裡如一", "心口如一"],
            synonyms: ["前後不一", "漏洞百出"],
            antonyms: ["言行一致", "表裡如一"]
          },
          { 
            id: 304, set: 3, word: "因材施教", zhuyin: "ㄧㄣ ㄘㄞˊ ㄕ ㄐㄧㄠˋ", 
            meaning: "依據學生的資質、才幹，給予適當的教育。", 
            example: "老師懂得____，讓每個學生都能發揮專長。", 
            options: ["因材施教", "一視同仁", "拔苗助長", "對牛彈琴"],
            synonyms: ["量體裁衣"],
            antonyms: ["一視同仁", "千篇一律"]
          },
          { 
            id: 305, set: 3, word: "自投羅網", zhuyin: "ㄗˋ ㄊㄡˊ ㄌㄨㄛˊ ㄨㄤˇ", 
            meaning: "比喻落入圈套或自取災禍。", 
            example: "壞人以為這裡安全，結果卻是____，被警察抓個正著。", 
            options: ["自投羅網", "逃之夭夭", "全身而退", "明哲保身"],
            synonyms: ["飛蛾撲火", "作繭自縛"],
            antonyms: ["逃之夭夭", "全身而退"]
          },

          // --- 第 4 組 (7-8 畫) ---
          { 
            id: 401, set: 4, word: "呆若木雞", zhuyin: "ㄉㄞ ㄖㄨㄛˋ ㄇㄨˋ ㄐㄧ", 
            meaning: "形容因驚恐或驚訝而發愣的樣子。", 
            example: "聽到這個驚人的消息，他整個人____，說不出話來。", 
            options: ["呆若木雞", "神采飛揚", "談笑風生", "泰然自若"],
            synonyms: ["目瞪口呆", "瞠目結舌"],
            antonyms: ["神采飛揚", "從容不迫"]
          },
          { 
            id: 402, set: 4, word: "花言巧語", zhuyin: "ㄏㄨㄚ ㄧㄢˊ ㄑㄧㄠˇ ㄩˇ", 
            meaning: "形容虛假而動聽的言語。", 
            example: "不要相信詐騙集團的____，以免上當受騙。", 
            options: ["花言巧語", "忠言逆耳", "金玉良言", "肺腑之言"],
            synonyms: ["甜言蜜語", "口蜜腹劍"],
            antonyms: ["肺腑之言", "忠言逆耳", "金玉良言"]
          },
          { 
            id: 403, set: 4, word: "表裡如一", zhuyin: "ㄅㄧㄠˇ ㄌㄧˇ ㄖㄨˊ ㄧ", 
            meaning: "指外表和內心一致。", 
            example: "他是一個____的君子，絕對不會在背後說人壞話。", 
            options: ["表裡如一", "口是心非", "兩面三刀", "陽奉陰違"],
            synonyms: ["言行一致", "誠心誠意"],
            antonyms: ["口是心非", "表裡不一", "笑裡藏刀"]
          },
          { 
            id: 404, set: 4, word: "柳暗花明", zhuyin: "ㄌㄧㄡˇ ㄢˋ ㄏㄨㄚ ㄇㄧㄥˊ", 
            meaning: "比喻在絕望中產生轉機。", 
            example: "只要不放棄，事情總會有____的一天。", 
            options: ["柳暗花明", "山窮水盡", "走投無路", "日暮途窮"],
            synonyms: ["峰迴路轉", "絕處逢生"],
            antonyms: ["山窮水盡", "走投無路"]
          },
          { 
            id: 405, set: 4, word: "垂頭喪氣", zhuyin: "ㄔㄨㄟˊ ㄊㄡˊ ㄙㄤˋ ㄑㄧˋ", 
            meaning: "形容失意沮喪的樣子。", 
            example: "比賽輸了，隊員們個個____。", 
            options: ["垂頭喪氣", "趾高氣揚", "得意洋洋", "意氣風發"],
            synonyms: ["灰心喪氣", "無精打采"],
            antonyms: ["趾高氣揚", "神采飛揚", "意氣風發"]
          },

          // --- 第 5 組 (9-10 畫) ---
          { 
            id: 501, set: 5, word: "害群之馬", zhuyin: "ㄏㄞˋ ㄑㄩㄣˊ ㄓ ㄇㄚˇ", 
            meaning: "比喻危害群體的人。", 
            example: "我們要遵守班規，不要當____。", 
            options: ["害群之馬", "棟樑之才", "中流砥柱", "人中之龍"],
            synonyms: ["群蟻附羶"],
            antonyms: ["棟樑之才", "中流砥柱"]
          },
          { 
            id: 502, set: 5, word: "捕風捉影", zhuyin: "ㄅㄨˇ ㄈㄥ ㄓㄨㄛ ㄧㄥˇ", 
            meaning: "比喻說話或做事沒有事實根據。", 
            example: "這件事純屬____的謠言，大家不要相信。", 
            options: ["捕風捉影", "實事求是", "證據確鑿", "鐵證如山"],
            synonyms: ["無中生有", "空穴來風"],
            antonyms: ["實事求是", "鐵證如山"]
          },
          { 
            id: 503, set: 5, word: "挺身而出", zhuyin: "ㄊㄧㄥˇ ㄕㄣ ㄦˊ ㄔㄨ", 
            meaning: "遇到危難或責任時，勇敢地站出來。", 
            example: "看到有人被欺負，他立刻____主持公道。", 
            options: ["挺身而出", "袖手旁觀", "畏縮不前", "置身事外"],
            synonyms: ["自告奮勇", "見義勇為"],
            antonyms: ["袖手旁觀", "畏縮不前", "明哲保身"]
          },
          { 
            id: 504, set: 5, word: "得心應手", zhuyin: "ㄉㄜˊ ㄒㄧㄣ ㄧㄥˋ ㄕㄡˇ", 
            meaning: "形容技藝熟練，運用自如。", 
            example: "他彈鋼琴已經到了____的境界。", 
            options: ["得心應手", "手忙腳亂", "力不從心", "笨手笨腳"],
            synonyms: ["運用自如", "駕輕就熟"],
            antonyms: ["手忙腳亂", "力不從心", "束手無策"]
          },
          { 
            id: 505, set: 5, word: "頂天立地", zhuyin: "ㄉㄧㄥˇ ㄊㄧㄢ ㄌㄧˋ ㄉㄧˋ", 
            meaning: "形容人氣概豪邁，光明正大。", 
            example: "做人要____，仰不愧於天，俯不怍於人。", 
            options: ["頂天立地", "卑躬屈膝", "奴顏婢膝", "唯唯諾諾"],
            synonyms: ["光明磊落"],
            antonyms: ["卑躬屈膝", "奴顏婢膝"]
          },

          // --- 第 6 組 (11-12 畫) ---
          { 
            id: 601, set: 6, word: "喜出望外", zhuyin: "ㄒㄧˇ ㄔㄨ ㄨㄤˋ ㄨㄞˋ", 
            meaning: "因意想不到的喜事而特別高興。", 
            example: "聽到中了頭獎的消息，他簡直____。", 
            options: ["喜出望外", "大失所望", "悲痛欲絕", "心如死灰"],
            synonyms: ["大喜過望", "欣喜若狂"],
            antonyms: ["大失所望", "悲痛欲絕", "晴天霹靂"]
          },
          { 
            id: 602, set: 6, word: "揚眉吐氣", zhuyin: "ㄧㄤˊ ㄇㄟˊ ㄊㄨˇ ㄑㄧˋ", 
            meaning: "形容擺脫壓抑心情後的興奮神情。", 
            example: "這次比賽奪冠，終於讓他____了。", 
            options: ["揚眉吐氣", "垂頭喪氣", "忍氣吞聲", "委曲求全"],
            synonyms: ["意氣風發"],
            antonyms: ["垂頭喪氣", "忍氣吞聲", "愁眉苦臉"]
          },
          { 
            id: 603, set: 6, word: "毫不氣餒", zhuyin: "ㄏㄠˊ ㄅㄨˋ ㄑㄧˋ ㄋㄟˇ", 
            meaning: "一點也不喪失勇氣。", 
            example: "雖然失敗了很多次，但他____，繼續努力。", 
            options: ["毫不氣餒", "心灰意冷", "半途而廢", "一蹶不振"],
            synonyms: ["再接再厲", "百折不撓"],
            antonyms: ["心灰意冷", "一蹶不振"]
          },
          { 
            id: 604, set: 6, word: "凱旋而歸", zhuyin: "ㄎㄞˇ ㄒㄩㄢˊ ㄦˊ ㄍㄨㄟ", 
            meaning: "獲勝歸來。", 
            example: "戰士們打贏了勝仗，____。", 
            options: ["凱旋而歸", "鎩羽而歸", "全軍覆沒", "大敗而逃"],
            synonyms: ["滿載而歸", "班師回朝"],
            antonyms: ["鎩羽而歸", "全軍覆沒", "一敗塗地"]
          },
          { 
            id: 605, set: 6, word: "富可敵國", zhuyin: "ㄈㄨˋ ㄎㄜˇ ㄉㄧˊ ㄍㄨㄛˊ", 
            meaning: "形容極為富有。", 
            example: "傳說這位商人的財富____，令人羨慕。", 
            options: ["富可敵國", "一貧如洗", "家徒四壁", "身無分文"],
            synonyms: ["腰纏萬貫", "揮金如土"],
            antonyms: ["一貧如洗", "家徒四壁", "兩袖清風"]
          },
        ];

        // --- 3. 狀態變數 (State) ---
        let state = {
            view: 'home', // home, sets, activities, practice, result
            currentSet: 1,
            activityType: 'learn', // learn, quiz_meaning, quiz_synonym_antonym, fill_blank, comprehensive
            currentIndex: 0,
            score: 0,
            answersLog: [],
            studentName: '',
            scriptUrl: 'https://script.google.com/macros/s/AKfycbyoFfvC-xeLlAcfG2uI-cGUdm7YFVKJyGO7NEiekYOYIWJLEMDUBPIh83QjKwHQyJjs-g/exec',
            feedback: null, // 'correct', 'wrong'
            isSubmitting: false,
            submitStatus: null
        };

        // --- 4. 輔助函式 ---
        
        function getSetData() {
            return idiomDatabase.filter(item => item.set === state.currentSet);
        }

        // --- 5. 核心邏輯 ---

        function updateState(updates) {
            state = { ...state, ...updates };
            render();
        }

        function handleStart() {
            if (!state.studentName.trim()) {
                alert("請先輸入名字喔！");
                return;
            }
            updateState({ view: 'sets' });
        }

        function startPractice(type) {
            updateState({
                activityType: type,
                currentIndex: 0,
                score: 0,
                answersLog: [],
                feedback: null,
                submitStatus: null,
                view: 'practice'
            });
        }

        // 取得隨機錯誤選項 (從同組題目中撈)
        function getDistractors(excludeWord, count, questions) {
            const others = questions.filter(q => q.word !== excludeWord).map(q => q.word);
            return others.sort(() => Math.random() - 0.5).slice(0, count);
        }

        function handleAnswer(selectedOption, correctOption, questionData, questionText) {
            const isCorrect = selectedOption === correctOption;
            
            // 記錄
            const logEntry = {
                question: questionText || questionData.word,
                type: state.activityType,
                userAnswer: selectedOption,
                correctAnswer: correctOption,
                isCorrect: isCorrect,
                timestamp: new Date().toISOString()
            };

            const newLog = [...state.answersLog, logEntry];
            let newScore = state.score;
            if (isCorrect) newScore += 10;

            updateState({ 
                feedback: isCorrect ? 'correct' : 'wrong',
                score: newScore,
                answersLog: newLog
            });

            // 延遲跳轉
            setTimeout(() => {
                const questions = getSetData();
                if (state.currentIndex < questions.length - 1) {
                    updateState({ 
                        feedback: null, 
                        currentIndex: state.currentIndex + 1 
                    });
                } else {
                    updateState({ 
                        feedback: null, 
                        view: 'result' 
                    });
                }
            }, 1500);
        }

        async function submitToGoogle() {
            if (!state.scriptUrl) {
                alert("請先設定 Google Apps Script 網址！");
                return;
            }
            updateState({ isSubmitting: true });

            const payload = {
                studentName: state.studentName,
                set: state.currentSet,
                mode: state.activityType,
                score: state.score,
                totalQuestions: getSetData().length,
                timestamp: new Date().toLocaleString(),
                details: JSON.stringify(state.answersLog.map(a => `${a.question.substring(0, 10)}...(${a.isCorrect?'O':'X'})`))
            };

            try {
                await fetch(state.scriptUrl, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                updateState({ isSubmitting: false, submitStatus: 'success' });
            } catch (error) {
                console.error(error);
                updateState({ isSubmitting: false, submitStatus: 'error' });
            }
        }

        // --- 6. 渲染函式 (Render Views) ---

        function render() {
            const app = document.getElementById('app');
            app.innerHTML = ''; // 清空容器

            switch (state.view) {
                case 'home': app.appendChild(renderHome()); break;
                case 'sets': app.appendChild(renderSets()); break;
                case 'activities': app.appendChild(renderActivities()); break;
                case 'practice': app.appendChild(renderPractice()); break;
                case 'result': app.appendChild(renderResult()); break;
                default: app.appendChild(renderHome());
            }
        }

        function renderHome() {
            const div = document.createElement('div');
            div.className = "flex flex-col items-center justify-center h-full flex-grow space-y-8 p-6 bg-gradient-to-b from-blue-100 to-blue-50";
            div.innerHTML = `
                <h1 class="text-5xl font-bold text-blue-600 tracking-wider mb-4 drop-shadow-sm text-center">成語探險家</h1>
                <div class="text-xl text-gray-600 mb-8 text-center">國小五年級 - 互動練習平台</div>
                <div class="bg-white p-6 rounded-2xl shadow-xl w-full max-w-md">
                    <label class="block text-gray-700 font-bold mb-2">我是...</label>
                    <input id="nameInput" type="text" placeholder="請輸入你的名字" class="w-full p-3 border-2 border-blue-200 rounded-xl text-lg focus:border-blue-500 focus:outline-none transition" value="${state.studentName}">
                </div>
                <button id="startBtn" class="px-10 py-4 bg-blue-500 hover:bg-blue-600 text-white text-2xl font-bold rounded-full shadow-lg transform transition hover:scale-105 flex items-center gap-2 btn-hover">
                    開始冒險 ${Icons.ChevronRight}
                </button>
                <div class="mt-12 text-xs text-gray-400 w-full max-w-md">
                    <details>
                        <summary>老師設定 (Google Sheet URL)</summary>
                        <input id="urlInput" type="text" class="w-full p-2 border mt-2 rounded" placeholder="貼上 Apps Script 網址" value="${state.scriptUrl}">
                    </details>
                </div>
            `;
            
            // Bind events
            div.querySelector('#nameInput').addEventListener('input', (e) => state.studentName = e.target.value);
            div.querySelector('#urlInput').addEventListener('input', (e) => state.scriptUrl = e.target.value);
            div.querySelector('#startBtn').addEventListener('click', handleStart);
            
            return div;
        }

        function renderSets() {
            const div = document.createElement('div');
            div.className = "p-6 bg-blue-50 min-h-screen";
            
            let buttonsHtml = '';
            for (let i = 1; i <= 6; i++) {
                buttonsHtml += `
                    <button onclick="selectSet(${i})" class="h-40 bg-white rounded-2xl shadow-md hover:shadow-xl hover:bg-blue-50 transition border-b-4 border-blue-200 hover:border-blue-400 flex flex-col items-center justify-center gap-2 btn-hover">
                        <span class="text-4xl font-black text-blue-300">0${i}</span>
                        <span class="text-xl font-bold text-gray-700">第 ${i} 練習</span>
                        <span class="text-sm text-gray-500">適合筆畫: ${i * 2 - 1}~${i * 2} 畫</span>
                    </button>
                `;
            }

            div.innerHTML = `
                <button onclick="updateState({view: 'home'})" class="mb-4 text-blue-500 font-bold flex items-center">← 回首頁</button>
                <h2 class="text-3xl font-bold text-center text-blue-800 mb-8">選擇挑戰關卡</h2>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-6 max-w-4xl mx-auto">
                    ${buttonsHtml}
                </div>
            `;
            return div;
        }

        // Global exposing for inline onclick
        window.selectSet = (setNum) => updateState({ currentSet: setNum, view: 'activities' });
        window.updateState = updateState;

        function renderActivities() {
            const div = document.createElement('div');
            div.className = "p-6 bg-indigo-50 min-h-screen flex flex-col items-center";
            
            // Helper to create card HTML
            const createCard = (icon, title, desc, color, type) => `
                <button onclick="window.appStartPractice('${type}')" class="p-6 rounded-2xl border-b-4 text-left transition hover:-translate-y-1 hover:shadow-lg flex items-start gap-4 ${color} w-full btn-hover">
                    <div class="p-2 bg-white bg-opacity-50 rounded-lg text-gray-800">${icon}</div>
                    <div>
                        <h3 class="text-xl font-bold mb-1">${title}</h3>
                        <p class="text-sm opacity-90">${desc}</p>
                    </div>
                </button>
            `;

            div.innerHTML = `
                <button onclick="updateState({view: 'sets'})" class="self-start mb-4 text-indigo-500 font-bold">← 回關卡選單</button>
                <h2 class="text-3xl font-bold text-indigo-800 mb-2">第 ${state.currentSet} 練習：選擇模式</h2>
                <p class="text-gray-500 mb-8">準備好要挑戰什麼了嗎？</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 w-full max-w-3xl">
                    ${createCard(Icons.BookOpen, "成語解釋 (學習)", "先來認識這些成語的意思和注音吧！", "bg-green-100 text-green-700 border-green-300", 'learn')}
                    ${createCard(Icons.Star, "選出正確答案", "根據解釋，選出正確的成語。", "bg-yellow-100 text-yellow-700 border-yellow-300", 'quiz_meaning')}
                    ${createCard(Icons.ArrowLeftRight, "相似/相反詞挑戰", "這個成語跟誰意思相近或相反？", "bg-purple-100 text-purple-700 border-purple-300", 'quiz_synonym_antonym')}
                    ${createCard(Icons.Edit3, "靈活運用 (填空)", "讀例句，把適合的成語填進去。", "bg-pink-100 text-pink-700 border-pink-300", 'fill_blank')}
                    <div class="col-span-1 md:col-span-2">
                         ${createCard(Icons.Trophy, "綜合大測驗", "包含解釋、填空與相似相反詞題型！", "bg-blue-100 text-blue-700 border-blue-300", 'comprehensive')}
                    </div>
                </div>
            `;
            return div;
        }

        window.appStartPractice = startPractice;

        function renderPractice() {
            const div = document.createElement('div');
            const questions = getSetData();
            const currentQ = questions[state.currentIndex];

            // --- A. 學習模式 ---
            if (state.activityType === 'learn') {
                div.className = "flex flex-col items-center justify-center min-h-screen bg-green-50 p-6";
                div.innerHTML = `
                    <div class="bg-white rounded-3xl shadow-xl p-8 max-w-2xl w-full text-center relative overflow-hidden animate-fade-in">
                        <div class="absolute top-0 left-0 w-full h-4 bg-green-400"></div>
                        <span class="text-gray-400 text-sm font-bold tracking-widest uppercase mb-2 block">Card ${state.currentIndex + 1} / ${questions.length}</span>
                        
                        <h1 class="text-6xl font-black text-gray-800 mb-4">${currentQ.word}</h1>
                        <div class="text-3xl text-green-600 font-serif mb-8">${currentQ.zhuyin}</div>
                        
                        <div class="bg-green-50 rounded-xl p-6 mb-4 text-left">
                            <h3 class="font-bold text-green-800 mb-2">【解釋】</h3>
                            <p class="text-xl text-gray-700">${currentQ.meaning}</p>
                        </div>

                        <div class="bg-blue-50 rounded-xl p-6 text-left border-l-4 border-blue-400 mb-4">
                            <h3 class="font-bold text-blue-800 mb-2">【例句】</h3>
                            <p class="text-lg text-gray-700">${currentQ.example.replace('____', currentQ.word)}</p>
                        </div>

                        <div class="grid grid-cols-2 gap-4 text-sm mb-8">
                            <div class="bg-purple-50 p-2 rounded text-purple-800 text-left">
                                <span class="font-bold">相似詞：</span>${currentQ.synonyms?.join("、") || "無"}
                            </div>
                            <div class="bg-red-50 p-2 rounded text-red-800 text-left">
                                <span class="font-bold">相反詞：</span>${currentQ.antonyms?.join("、") || "無"}
                            </div>
                        </div>

                        <div class="flex justify-between">
                            <button id="prevBtn" class="px-6 py-2 rounded-lg bg-gray-200 text-gray-600 disabled:opacity-50" ${state.currentIndex === 0 ? 'disabled' : ''}>上一個</button>
                            <button id="nextBtn" class="px-6 py-2 rounded-lg bg-green-500 text-white font-bold hover:bg-green-600 btn-hover">
                                ${state.currentIndex < questions.length - 1 ? '下一個' : '完成學習'}
                            </button>
                        </div>
                    </div>
                `;

                div.querySelector('#prevBtn').onclick = () => updateState({ currentIndex: state.currentIndex - 1 });
                div.querySelector('#nextBtn').onclick = () => {
                    if (state.currentIndex < questions.length - 1) {
                        updateState({ currentIndex: state.currentIndex + 1 });
                    } else {
                        updateState({ view: 'activities' });
                    }
                };
                return div;
            }

            // --- B. 測驗模式邏輯 ---
            div.className = "flex flex-col items-center min-h-screen bg-yellow-50 p-4";

            let questionText = "";
            let options = [];
            let correctAnswer = "";

            // 題型邏輯
            if (state.activityType === 'quiz_meaning') {
                questionText = `「${currentQ.meaning}」 是哪一個成語？`;
                correctAnswer = currentQ.word;
                options = currentQ.options;
            } 
            else if (state.activityType === 'fill_blank') {
                questionText = currentQ.example;
                correctAnswer = currentQ.word;
                options = currentQ.options;
            }
            
            // 處理相似/相反詞與綜合測驗的邏輯
            const setupSynAnt = () => {
                 const hasSyn = currentQ.synonyms && currentQ.synonyms.length > 0;
                 const hasAnt = currentQ.antonyms && currentQ.antonyms.length > 0;
                 let type = 'syn'; 
                 if (hasSyn && hasAnt) type = Math.random() > 0.5 ? 'syn' : 'ant';
                 else if (hasAnt) type = 'ant';

                 if (type === 'syn') {
                     correctAnswer = currentQ.synonyms[0];
                     questionText = `下列哪一個是「${currentQ.word}」的相似詞？`;
                     let distractors = currentQ.antonyms ? [...currentQ.antonyms] : [];
                     if(distractors.length < 3) distractors = [...distractors, ...getDistractors(currentQ.word, 3 - distractors.length, questions)];
                     options = [correctAnswer, ...distractors.slice(0,3)].sort(() => Math.random() - 0.5);
                 } else {
                     correctAnswer = currentQ.antonyms[0];
                     questionText = `下列哪一個是「${currentQ.word}」的相反詞？`;
                     let distractors = currentQ.synonyms ? [...currentQ.synonyms] : [];
                     if(distractors.length < 3) distractors = [...distractors, ...getDistractors(currentQ.word, 3 - distractors.length, questions)];
                     options = [correctAnswer, ...distractors.slice(0,3)].sort(() => Math.random() - 0.5);
                 }
            };

            if (state.activityType === 'quiz_synonym_antonym') {
                setupSynAnt();
            }
            else if (state.activityType === 'comprehensive') {
                const seed = (state.currentIndex + state.score) % 3;
                if(seed === 0) {
                    questionText = `「${currentQ.meaning}」 是哪一個成語？`;
                    correctAnswer = currentQ.word;
                    options = currentQ.options;
                } else if (seed === 1) {
                    questionText = currentQ.example;
                    correctAnswer = currentQ.word;
                    options = currentQ.options;
                } else {
                    setupSynAnt();
                }
            }

            // 渲染測驗介面
            const progress = ((state.currentIndex) / questions.length) * 100;
            
            let feedbackOverlay = '';
            if (state.feedback === 'correct') {
                feedbackOverlay = `
                    <div class="absolute inset-0 bg-green-100 bg-opacity-95 rounded-2xl flex flex-col items-center justify-center z-10 animate-fade-in">
                        <div class="text-green-500">${Icons.CheckCircle}</div>
                        <span class="text-4xl font-black text-green-600 mt-4">答對了！</span>
                    </div>`;
            } else if (state.feedback === 'wrong') {
                feedbackOverlay = `
                    <div class="absolute inset-0 bg-red-100 bg-opacity-95 rounded-2xl flex flex-col items-center justify-center z-10 animate-fade-in">
                        <div class="text-red-500">${Icons.XCircle}</div>
                        <span class="text-4xl font-black text-red-600 mt-4">再試一次！</span>
                    </div>`;
            }

            let optionsHtml = options.map(opt => `
                <button onclick="window.appHandleAnswer('${opt}', '${correctAnswer}', '${encodeURIComponent(JSON.stringify(currentQ))}', '${encodeURIComponent(questionText)}')" 
                    class="p-4 rounded-xl border-2 border-gray-100 bg-gray-50 hover:bg-yellow-100 hover:border-yellow-300 text-xl font-bold text-gray-700 transition active:scale-95 btn-hover">
                    ${opt}
                </button>
            `).join('');

            div.innerHTML = `
                <div class="w-full max-w-2xl h-4 bg-gray-200 rounded-full mb-6 overflow-hidden">
                    <div class="h-full bg-yellow-400 transition-all duration-500 ease-out" style="width: ${progress}%"></div>
                </div>

                <div class="bg-white rounded-2xl shadow-lg p-8 max-w-2xl w-full text-center relative min-h-[400px] flex flex-col justify-center">
                    ${feedbackOverlay}
                    <h2 class="text-lg text-gray-500 font-bold mb-6 flex items-center justify-center gap-2">
                        題目 ${state.currentIndex + 1} / ${questions.length} 
                        ${state.activityType === 'comprehensive' ? '<span class="bg-blue-100 text-blue-600 text-xs px-2 py-1 rounded">綜合挑戰</span>' : ''}
                    </h2>
                    
                    <div class="text-2xl font-bold text-gray-800 mb-10 leading-relaxed min-h-[100px] flex items-center justify-center px-4">
                        ${questionText}
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 w-full">
                        ${optionsHtml}
                    </div>
                </div>
                <div class="mt-8 text-xl font-bold text-yellow-600">目前分數：${state.score}</div>
            `;
            return div;
        }

        // Bridge for complex data passing in onclick
        window.appHandleAnswer = (sel, cor, qDataStr, qTextStr) => {
            const qData = JSON.parse(decodeURIComponent(qDataStr));
            const qText = decodeURIComponent(qTextStr);
            handleAnswer(sel, cor, qData, qText);
        }

        function renderResult() {
            const div = document.createElement('div');
            div.className = "flex flex-col items-center justify-center min-h-screen bg-purple-50 p-6";
            
            const submitBtnContent = state.isSubmitting 
                ? `<span class="animate-spin mr-2">${Icons.Refresh}</span> 處理中...` 
                : (state.submitStatus === 'success' ? `${Icons.CheckCircle} 成績已儲存` : `${Icons.Save} 儲存成績`);

            const btnClass = state.submitStatus === 'success'
                ? 'bg-green-500 text-white cursor-default'
                : 'bg-blue-600 text-white hover:bg-blue-700 shadow-lg hover:shadow-xl';

            div.innerHTML = `
                <div class="bg-white p-10 rounded-3xl shadow-2xl text-center max-w-lg w-full animate-fade-in">
                    <div class="text-yellow-400 mx-auto w-20 mb-6">${Icons.Trophy}</div>
                    <h2 class="text-4xl font-black text-gray-800 mb-2">練習完成！</h2>
                    <p class="text-xl text-gray-500 mb-8">${state.studentName}，你真棒！</p>
                    
                    <div class="bg-purple-100 rounded-xl p-6 mb-8">
                        <span class="block text-sm text-purple-600 font-bold uppercase tracking-wider">Total Score</span>
                        <span class="text-6xl font-black text-purple-700">${state.score}</span>
                        <span class="text-purple-400 text-xl"> / ${getSetData().length * 10} 分</span>
                    </div>

                    <div class="space-y-3">
                        <button id="submitBtn" class="w-full py-4 rounded-xl font-bold text-xl flex items-center justify-center gap-2 transition ${btnClass}" ${state.submitStatus === 'success' ? 'disabled' : ''}>
                            ${submitBtnContent}
                        </button>

                        <button onclick="updateState({view: 'sets'})" class="w-full py-4 rounded-xl font-bold text-xl text-gray-600 bg-gray-100 hover:bg-gray-200 transition">
                            練習其他關卡
                        </button>
                    </div>
                    ${state.submitStatus === 'error' ? '<p class="text-red-500 mt-2 text-sm">儲存失敗，請檢查網路或通知老師。</p>' : ''}
                </div>
            `;
            
            div.querySelector('#submitBtn').onclick = submitToGoogle;
            return div;
        }

        // --- 初始化 ---
        render();

    </script>
</body>
</html>
