<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>陳以婷的成語探險家</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        .animate-fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .btn-hover:active {
            transform: scale(0.95);
        }
        
        /* 隱藏捲軸但保留功能 */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body class="bg-pink-50 text-gray-800 min-h-screen">

    <!-- 應用程式容器 -->
    <div id="app" class="min-h-screen flex flex-col">
        <!-- 內容將由 JavaScript 動態渲染 -->
    </div>

    <script>
        // --- 1. SVG 圖示庫 ---
        const Icons = {
            ChevronRight: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>`,
            BookOpen: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>`,
            Star: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>`,
            ArrowLeftRight: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3 4 7l4 4"/><path d="M4 7h16"/><path d="m16 21 4-4-4-4"/><path d="M20 17H4"/></svg>`,
            Edit3: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"/></svg>`,
            Trophy: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>`,
            CheckCircle: `<svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>`,
            XCircle: `<svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>`,
            Save: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>`,
            Refresh: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 2v6h-6"/><path d="M3 12a9 9 0 0 1 15-6.7L21 8"/><path d="M3 22v-6h6"/><path d="M21 12a9 9 0 0 1-15 6.7L3 16"/></svg>`,
            Clipboard: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></svg>`,
            Check: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>`,
            X: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>`,
            Trash: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>`,
            Eye: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>`,
            CloudUpload: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="M12 12v9"/><path d="m16 16-4-4-4 4"/></svg>`
        };

        // --- 2. 成語資料庫 ---
        // (保持與前一版完全相同，包含 Set 1 ~ Set 8 的所有成語)
        const idiomDatabase = [
          // --- Set 1 (1-2 畫) ---
          { set: 1, word: "一言為定", zhuyin: "ㄧ ㄧㄢˊ ㄨㄟˊ ㄉㄧㄥˋ", meaning: "說好就算數，不反悔。", example: "我們約好明天見，____，不見不散。", synonyms: ["一諾千金", "言而有信"], antonyms: ["出爾反爾", "食言而肥"] },
          { set: 1, word: "一事無成", zhuyin: "ㄧ ㄕˋ ㄨˊ ㄔㄥˊ", meaning: "什麼成就都沒有。", example: "如果不努力，將來可能會____。", synonyms: ["一無所成"], antonyms: ["功成名就", "大有可為"] },
          { set: 1, word: "一知半解", zhuyin: "ㄧ ㄓ ㄅㄢˋ ㄐㄧㄝˇ", meaning: "懂一點點但不完整。", example: "對這件事我只是____，不敢亂說。", synonyms: ["略知皮毛"], antonyms: ["融會貫通", "博古通今"] },
          { set: 1, word: "一鼓作氣", zhuyin: "ㄧ ㄍㄨˇ ㄗㄨㄛˋ ㄑㄧˋ", meaning: "趁著氣勢一次把事做好。", example: "大家決定____，把剩下的工作全部做完。", synonyms: ["打鐵趁熱"], antonyms: ["一曝十寒", "半途而廢"] },
          { set: 1, word: "一見如故", zhuyin: "ㄧ ㄐㄧㄢˋ ㄖㄨˊ ㄍㄨˋ", meaning: "第一次見面就像老朋友。", example: "我和他雖然初次見面，卻____，聊得很開心。", synonyms: ["一見傾心"], antonyms: ["視同路人"] },
          { set: 1, word: "一目了然", zhuyin: "ㄧ ㄇㄨˋ ㄌㄧㄠˇ ㄖㄢˊ", meaning: "一下就看得很清楚。", example: "這張圖表製作得很清楚，讓人____。", synonyms: ["一清二楚"], antonyms: ["霧裡看花"] },
          { set: 1, word: "一舉兩得", zhuyin: "ㄧ ㄐㄩˇ ㄌㄧㄤˇ ㄉㄜˊ", meaning: "做一件事得到兩種好處。", example: "運動既能健身又能紓壓，真是____。", synonyms: ["一石二鳥", "事半功倍"], antonyms: ["徒勞無功"] },
          { set: 1, word: "一絲不苟", zhuyin: "ㄧ ㄙ ㄅㄨˋ ㄍㄡˇ", meaning: "做事非常仔細不馬虎。", example: "他做事____，連最細微的地方都不放過。", synonyms: ["小心翼翼", "兢兢業業"], antonyms: ["粗枝大葉", "馬馬虎虎"] },
          { set: 1, word: "九霄雲外", zhuyin: "ㄐㄧㄡˇ ㄒㄧㄠ ㄩㄣˊ ㄨㄞˋ", meaning: "把事情拋到很遠，早忘了。", example: "放假了，我把煩惱都拋到____。", synonyms: ["置之度外"], antonyms: ["銘記在心"] },
          { set: 1, word: "人山人海", zhuyin: "ㄖㄣˊ ㄕㄢ ㄖㄣˊ ㄏㄞˇ", meaning: "人非常多，像山和海一樣。", example: "跨年晚會現場____，非常熱鬧。", synonyms: ["萬人空巷"], antonyms: ["門可羅雀", "人煙稀少"] },
          { set: 1, word: "人心不古", zhuyin: "ㄖㄣˊ ㄒㄧㄣ ㄅㄨˋ ㄍㄨˇ", meaning: "感嘆人心不如從前純厚。", example: "現在詐騙很多，真是____。", synonyms: ["世風日下"], antonyms: ["民風淳樸"] },
          { set: 1, word: "人仰馬翻", zhuyin: "ㄖㄣˊ ㄧㄤˇ ㄇㄚˇ ㄈㄢ", meaning: "場面混亂、大家忙亂跌倒。", example: "為了趕工，大家忙得____。", synonyms: ["手忙腳亂"], antonyms: ["井井有條"] },
          { set: 1, word: "八面玲瓏", zhuyin: "ㄅㄚ ㄇㄧㄢˋ ㄌㄧㄥˊ ㄌㄨㄥˊ", meaning: "做事圓滑、各方面都顧到。", example: "他待人處事____，大家都喜歡他。", synonyms: ["面面俱到"], antonyms: ["剛愎自用"] },
          { set: 1, word: "力不從心", zhuyin: "ㄌㄧˋ ㄅㄨˋ ㄘㄨㄥˊ ㄒㄧㄣ", meaning: "想做但能力跟不上。", example: "我想幫忙，但實在是____。", synonyms: ["無能為力"], antonyms: ["得心應手", "游刃有餘"] },
          { set: 1, word: "入木三分", zhuyin: "ㄖㄨˋ ㄇㄨˋ ㄙㄢ ㄈㄣ", meaning: "形容深刻有力(多指文章/觀察)。", example: "這篇評論分析得____，令人佩服。", synonyms: ["鞭辟入裡"], antonyms: ["不痛不癢"] },
          { set: 1, word: "二話不說", zhuyin: "ㄦˋ ㄏㄨㄚˋ ㄅㄨˋ ㄕㄨㄛ", meaning: "不多說，立刻去做。", example: "聽到朋友有難，他____立刻趕去幫忙。", synonyms: ["毫不猶豫"], antonyms: ["猶豫不決"] },

          // --- Set 2 (3-4 畫) ---
          { set: 2, word: "大公無私", zhuyin: "ㄉㄚˋ ㄍㄨㄥ ㄨˊ ㄙ", meaning: "做事公正，不為私利。", example: "班長處理事情____，大家都服氣。", synonyms: ["鐵面無私"], antonyms: ["假公濟私", "營私舞弊"] },
          { set: 2, word: "大器晚成", zhuyin: "ㄉㄚˋ ㄑㄧˋ ㄨㄢˇ ㄔㄥˊ", meaning: "有大才能的人較晚成功。", example: "別氣餒，你這是____，將來一定有成就。", synonyms: ["後來居上"], antonyms: ["小時了了"] },
          { set: 2, word: "大驚小怪", zhuyin: "ㄉㄚˋ ㄐㄧㄥ ㄒㄧㄠˇ ㄍㄨㄞˋ", meaning: "把小事看得太嚴重。", example: "這只是小感冒，別____。", synonyms: ["小題大作"], antonyms: ["處變不驚"] },
          { set: 2, word: "小心翼翼", zhuyin: "ㄒㄧㄠˇ ㄒㄧㄣ ㄧˋ ㄧˋ", meaning: "非常小心謹慎。", example: "他____地捧著剛做好的蛋糕。", synonyms: ["如履薄冰", "謹小慎微"], antonyms: ["粗心大意"] },
          { set: 2, word: "山高水長", zhuyin: "ㄕㄢ ㄍㄠ ㄕㄨㄟˇ ㄔㄤˊ", meaning: "比喻恩德深厚、情誼長久。", example: "老師的恩情____，我們永遠不會忘記。", synonyms: ["天長地久"], antonyms: [] },
          { set: 2, word: "口若懸河", zhuyin: "ㄎㄡˇ ㄖㄨㄛˋ ㄒㄩㄢˊ ㄏㄜˊ", meaning: "說話滔滔不絕。", example: "他一談起電影就____，停不下來。", synonyms: ["滔滔不絕"], antonyms: ["啞口無言", "沉默寡言"] },
          { set: 2, word: "千依百順", zhuyin: "ㄑㄧㄢ ㄧ ㄅㄞˇ ㄕㄨㄣˋ", meaning: "非常順從、不違背。", example: "他對父母____，是個孝順的孩子。", synonyms: ["百依百順"], antonyms: ["桀驁不馴"] },
          { set: 2, word: "三心二意", zhuyin: "ㄙㄢ ㄒㄧㄣ ㄦˋ ㄧˋ", meaning: "拿不定主意、不專心。", example: "做決定要果斷，不要____。", synonyms: ["猶豫不決"], antonyms: ["一心一意"] },
          { set: 2, word: "天造地設", zhuyin: "ㄊㄧㄢ ㄗㄠˋ ㄉㄧˋ ㄕㄜˋ", meaning: "天然形成，很合適。", example: "這裡風景優美，簡直是____的度假勝地。", synonyms: ["鬼斧神工"], antonyms: [] },
          { set: 2, word: "日新月異", zhuyin: "ㄖˋ ㄒㄧㄣ ㄩㄝˋ ㄧˋ", meaning: "每天都有新變化，進步很快。", example: "科技發展____，我們要不斷學習。", synonyms: ["一日千里"], antonyms: ["一成不變", "故步自封"] },
          { set: 2, word: "心曠神怡", zhuyin: "ㄒㄧㄣ ㄎㄨㄤˋ ㄕㄣˊ ㄧˊ", meaning: "心情開朗、精神愉快。", example: "走在森林步道，讓人感到____。", synonyms: ["心花怒放"], antonyms: ["心煩意亂"] },
          { set: 2, word: "手不釋卷", zhuyin: "ㄕㄡˇ ㄅㄨˋ ㄕˋ ㄐㄩㄢˋ", meaning: "很愛讀書，書不離手。", example: "他從小就____，學識非常豐富。", synonyms: ["好學不倦"], antonyms: ["不學無術"] },
          { set: 2, word: "水到渠成", zhuyin: "ㄕㄨㄟˇ ㄉㄠˋ ㄑㄩˊ ㄔㄥˊ", meaning: "條件具備，自然成功。", example: "只要平時努力，考試成績自然____。", synonyms: ["順理成章"], antonyms: ["拔苗助長"] },
          { set: 2, word: "少見多怪", zhuyin: "ㄕㄠˇ ㄐㄧㄢˋ ㄉㄨㄛ ㄍㄨㄞˋ", meaning: "見識少才覺得稀奇。", example: "這只是普通現象，你別____了。", synonyms: ["大驚小怪"], antonyms: ["見多識廣"] },
          { set: 2, word: "文思泉湧", zhuyin: "ㄨㄣˊ ㄙ ㄑㄩㄢˊ ㄩㄥˇ", meaning: "寫作靈感像泉水一樣湧出。", example: "作家今天____，一下午就寫了三篇文章。", synonyms: ["才思敏捷"], antonyms: ["江郎才盡"] },
          { set: 2, word: "不約而同", zhuyin: "ㄅㄨˋ ㄩㄝ ㄦˊ ㄊㄨㄥˊ", meaning: "沒商量卻做出同樣的事。", example: "大家____地為精彩的表演鼓掌。", synonyms: ["不謀而合"], antonyms: ["各持己見"] },

          // --- Set 3 (5-6 畫) ---
          { set: 3, word: "以身作則", zhuyin: "ㄧˇ ㄕㄣ ㄗㄨㄛˋ ㄗㄜˊ", meaning: "用自己的行動做榜樣。", example: "父母應該____，教導孩子正確的觀念。", synonyms: ["身體力行"], antonyms: ["只說不做"] },
          { set: 3, word: "出類拔萃", zhuyin: "ㄔㄨ ㄌㄟˋ ㄅㄚˊ ㄘㄨㄟˋ", meaning: "在同類中最突出。", example: "他的表現____，獲得了冠軍。", synonyms: ["鶴立雞群"], antonyms: ["濫竽充數"] },
          { set: 3, word: "失魂落魄", zhuyin: "ㄕ ㄏㄨㄣˊ ㄌㄨㄛˋ ㄆㄛˋ", meaning: "非常慌張或心神不定。", example: "聽到壞消息，他嚇得____。", synonyms: ["魂不守舍"], antonyms: ["神采飛揚"] },
          { set: 3, word: "半途而廢", zhuyin: "ㄅㄢˋ ㄊㄨˊ ㄦˊ ㄈㄟˋ", meaning: "做到一半就停止。", example: "學習樂器要持之以恆，不可____。", synonyms: ["功虧一簣"], antonyms: ["堅持到底"] },
          { set: 3, word: "左右為難", zhuyin: "ㄗㄨㄛˇ ㄧㄡˋ ㄨㄟˊ ㄋㄢˊ", meaning: "兩邊都不好選擇。", example: "一邊是友情一邊是正義，讓他____。", synonyms: ["進退兩難"], antonyms: ["當機立斷"] },
          { set: 3, word: "平易近人", zhuyin: "ㄆㄧㄥˊ ㄧˋ ㄐㄧㄣˋ ㄖㄣˊ", meaning: "態度和善，容易親近。", example: "這位校長____，學生都很喜歡他。", synonyms: ["和藹可親"], antonyms: ["高不可攀", "盛氣凌人"] },
          { set: 3, word: "正大光明", zhuyin: "ㄓㄥˋ ㄉㄚˋ ㄍㄨㄤ ㄇㄧㄥˊ", meaning: "坦坦蕩蕩，不做壞事。", example: "我們做事____，不怕別人閒話。", synonyms: ["光明磊落"], antonyms: ["鬼鬼祟祟"] },
          { set: 3, word: "白手起家", zhuyin: "ㄅㄞˊ ㄕㄡˇ ㄑㄧˇ ㄐㄧㄚ", meaning: "靠自己努力創立事業。", example: "他年輕時____，現在已是大老闆。", synonyms: ["自力更生"], antonyms: ["坐享其成"] },
          { set: 3, word: "因材施教", zhuyin: "ㄧㄣ ㄘㄞˊ ㄕ ㄐㄧㄠˋ", meaning: "依學生特點採不同教法。", example: "孔子提倡____，是偉大的教育家。", synonyms: ["量體裁衣"], antonyms: ["一視同仁"] },
          { set: 3, word: "全力以赴", zhuyin: "ㄑㄩㄢˊ ㄌㄧˋ ㄧˇ ㄈㄨˋ", meaning: "把全部力量投入去做。", example: "比賽雖然艱難，我們一定會____。", synonyms: ["竭盡所能"], antonyms: ["敷衍了事"] },
          { set: 3, word: "冰清玉潔", zhuyin: "ㄅㄧㄥ ㄑㄧㄥ ㄩˋ ㄐㄧㄝˊ", meaning: "品格純潔清白。", example: "她的人品____，令人敬重。", synonyms: ["潔身自愛"], antonyms: ["同流合汙"] },
          { set: 3, word: "行雲流水", zhuyin: "ㄒㄧㄥˊ ㄩㄣˊ ㄌㄧㄡˊ ㄕㄨㄟˇ", meaning: "文章或動作自然流暢。", example: "這篇文章寫得____，讀起來很舒服。", synonyms: ["揮灑自如"], antonyms: ["矯揉造作"] },
          { set: 3, word: "有志竟成", zhuyin: "ㄧㄡˇ ㄓˋ ㄐㄧㄥˋ ㄔㄥˊ", meaning: "有志向就能成功。", example: "相信____，只要努力夢想終會實現。", synonyms: ["皇天不負苦心人"], antonyms: [] },
          { set: 3, word: "先苦後甘", zhuyin: "ㄒㄧㄢ ㄎㄨˇ ㄏㄡˋ ㄍㄢ", meaning: "先辛苦後享受成果。", example: "讀書雖然辛苦，但____，未來會有好發展。", synonyms: ["苦盡甘來"], antonyms: [] },
          { set: 3, word: "同心協力", zhuyin: "ㄊㄨㄥˊ ㄒㄧㄣ ㄒㄧㄝˊ ㄌㄧˋ", meaning: "大家團結一起努力。", example: "只要大家____，沒有解決不了的難題。", synonyms: ["團結一致"], antonyms: ["一盤散沙"] },
          { set: 3, word: "光明磊落", zhuyin: "ㄍㄨㄤ ㄇㄧㄥˊ ㄌㄟˇ ㄌㄨㄛˋ", meaning: "做人坦蕩、正直。", example: "他一生____，深受大家敬重。", synonyms: ["正大光明"], antonyms: ["卑鄙無恥"] },

          // --- Set 4 (7-8 畫) ---
          { set: 4, word: "言而有信", zhuyin: "ㄧㄢˊ ㄦˊ ㄧㄡˇ ㄒㄧㄣˋ", meaning: "說到做到，守信用。", example: "做人要____，才能贏得信任。", synonyms: ["一諾千金"], antonyms: ["言而無信", "食言而肥"] },
          { set: 4, word: "事半功倍", zhuyin: "ㄕˋ ㄅㄢˋ ㄍㄨㄥ ㄅㄟˋ", meaning: "用較少力氣得更大成果。", example: "用對方法，學習就能____。", synonyms: ["一舉兩得"], antonyms: ["事倍功半"] },
          { set: 4, word: "志在必得", zhuyin: "ㄓˋ ㄗㄞˋ ㄅㄧˋ ㄉㄜˊ", meaning: "下定決心一定要得到。", example: "這次的冠軍，我們隊是____。", synonyms: ["勢在必得"], antonyms: [] },
          { set: 4, word: "身體力行", zhuyin: "ㄕㄣ ㄊㄧˇ ㄌㄧˋ ㄒㄧㄥˊ", meaning: "親自去做、用行動實踐。", example: "環保不能只用嘴說，要____。", synonyms: ["躬行實踐"], antonyms: ["紙上談兵"] },
          { set: 4, word: "吹毛求疵", zhuyin: "ㄔㄨㄟ ㄇㄠˊ ㄑㄧㄡˊ ㄘ", meaning: "過度挑剔小毛病。", example: "他對人總是____，很難相處。", synonyms: ["雞蛋裡挑骨頭"], antonyms: ["寬宏大量"] },
          { set: 4, word: "形影不離", zhuyin: "ㄒㄧㄥˊ ㄧㄥˇ ㄅㄨˋ ㄌㄧˊ", meaning: "關係親密，總在一起。", example: "他們兩個是____的好朋友。", synonyms: ["如膠似漆"], antonyms: ["若即若離"] },
          { set: 4, word: "兵分兩路", zhuyin: "ㄅㄧㄥ ㄈㄣ ㄌㄧㄤˇ ㄌㄨˋ", meaning: "分成兩隊同時行動。", example: "我們____，一組去買菜，一組去佈置。", synonyms: ["分頭進行"], antonyms: [] },
          { set: 4, word: "良師益友", zhuyin: "ㄌㄧㄤˊ ㄕ ㄧˋ ㄧㄡˇ", meaning: "能教導又能幫助的朋友。", example: "好書就像____，能帶給我們智慧。", synonyms: [], antonyms: ["損友"] },
          { set: 4, word: "刻苦耐勞", zhuyin: "ㄎㄜˋ ㄎㄨˇ ㄋㄞˋ ㄌㄠˊ", meaning: "能吃苦、能忍耐辛勞。", example: "農夫們____地在田裡工作。", synonyms: ["任勞任怨"], antonyms: ["好逸惡勞"] },
          { set: 4, word: "表裡如一", zhuyin: "ㄅㄧㄠˇ ㄌㄧˇ ㄖㄨˊ ㄧ", meaning: "外表和內心一致。", example: "他是個____的君子。", synonyms: ["言行一致"], antonyms: ["口是心非"] },
          { set: 4, word: "物以類聚", zhuyin: "ㄨˋ ㄧˇ ㄌㄟˋ ㄐㄩˋ", meaning: "同類的人或事會聚在一起。", example: "俗話說____，喜歡運動的人自然玩在一起。", synonyms: ["臭味相投"], antonyms: [] },
          { set: 4, word: "呼風喚雨", zhuyin: "ㄏㄨ ㄈㄥ ㄏㄨㄢˋ ㄩˇ", meaning: "形容本領大或影響力強。", example: "他在商場上____，極具影響力。", synonyms: ["興風作浪"], antonyms: [] },
          { set: 4, word: "居高臨下", zhuyin: "ㄐㄩ ㄍㄠ ㄌㄧㄣˊ ㄒㄧㄚˋ", meaning: "站得高往下看，佔優勢。", example: "登山隊____，俯瞰整個城市。", synonyms: ["高屋建瓴"], antonyms: [] },
          { set: 4, word: "拋磚引玉", zhuyin: "ㄆㄠ ㄓㄨㄢ ㄧㄣˇ ㄩˋ", meaning: "先提出粗淺看法引出好意見。", example: "我先發言____，希望大家多給意見。", synonyms: [], antonyms: [] },
          { set: 4, word: "和顏悅色", zhuyin: "ㄏㄜˊ ㄧㄢˊ ㄩㄝˋ ㄙㄜˋ", meaning: "態度和氣、表情愉快。", example: "老師總是____地指導我們。", synonyms: ["平易近人"], antonyms: ["聲色俱厲"] },
          { set: 4, word: "奉公守法", zhuyin: "ㄈㄥˋ ㄍㄨㄥ ㄕㄡˇ ㄈㄚˇ", meaning: "遵守法律，盡責做事。", example: "他是個____的好公民。", synonyms: ["循規蹈矩"], antonyms: ["作奸犯科"] },

          // --- Set 5 (9-10 畫) ---
          { set: 5, word: "冒險犯難", zhuyin: "ㄇㄠˋ ㄒㄧㄢˇ ㄈㄢˋ ㄋㄢˋ", meaning: "不怕危險困難，勇敢面對。", example: "消防員____衝進火場救人。", synonyms: ["出生入死"], antonyms: ["畏縮不前"] },
          { set: 5, word: "怨天尤人", zhuyin: "ㄩㄢˋ ㄊㄧㄢ ㄧㄡˊ ㄖㄣˊ", meaning: "怪天怪人，不反省自己。", example: "遇到挫折要檢討自己，不要____。", synonyms: ["推卸責任"], antonyms: ["反求諸己"] },
          { set: 5, word: "花言巧語", zhuyin: "ㄏㄨㄚ ㄧㄢˊ ㄑㄧㄠˇ ㄩˇ", meaning: "用好聽話哄騙人。", example: "別被他的____給騙了。", synonyms: ["甜言蜜語"], antonyms: ["肺腑之言"] },
          { set: 5, word: "風平浪靜", zhuyin: "ㄈㄥ ㄆㄧㄥˊ ㄌㄤˋ ㄐㄧㄥˋ", meaning: "沒有波折，平安順利。", example: "海面上____，適合航行。", synonyms: ["平安無事"], antonyms: ["驚濤駭浪"] },
          { set: 5, word: "洗耳恭聽", zhuyin: "ㄒㄧˇ ㄦˇ ㄍㄨㄥ ㄊㄧㄥ", meaning: "專心恭敬地聽。", example: "對於專家的意見，我們____。", synonyms: ["傾耳細聽"], antonyms: ["充耳不聞"] },
          { set: 5, word: "柳暗花明", zhuyin: "ㄌㄧㄡˇ ㄢˋ ㄏㄨㄚ ㄇㄧㄥˊ", meaning: "困境後出現轉機。", example: "堅持下去，總有____的一天。", synonyms: ["絕處逢生"], antonyms: ["山窮水盡"] },
          { set: 5, word: "面紅耳赤", zhuyin: "ㄇㄧㄢˋ ㄏㄨㄥˊ ㄦˇ ㄔˋ", meaning: "害羞或激動而臉紅。", example: "他們爭論得____，互不相讓。", synonyms: ["惱羞成怒"], antonyms: ["面不改色"] },
          { set: 5, word: "勇往直前", zhuyin: "ㄩㄥˇ ㄨㄤˇ ㄓˊ ㄑㄧㄢˊ", meaning: "不退縮，向前衝。", example: "為了夢想，我們要____。", synonyms: ["奮不顧身"], antonyms: ["畏縮不前"] },
          { set: 5, word: "原封不動", zhuyin: "ㄩㄢˊ ㄈㄥ ㄅㄨˋ ㄉㄨㄥˋ", meaning: "完全沒有改變。", example: "我把借來的書____地還給他。", synonyms: ["完好如初"], antonyms: ["面目全非"] },
          { set: 5, word: "害群之馬", zhuyin: "ㄏㄞˋ ㄑㄩㄣˊ ㄓ ㄇㄚˇ", meaning: "團體中帶來壞影響的人。", example: "我們要遵守紀律，不做____。", synonyms: ["老鼠屎"], antonyms: ["中流砥柱"] },
          { set: 5, word: "捕風捉影", zhuyin: "ㄅㄨˇ ㄈㄥ ㄓㄨㄛ ㄧㄥˇ", meaning: "沒有根據就亂猜。", example: "這些都是____的謠言，不可信。", synonyms: ["無中生有"], antonyms: ["鐵證如山"] },
          { set: 5, word: "高瞻遠矚", zhuyin: "ㄍㄠ ㄓㄢ ㄩㄢˇ ㄓㄨˇ", meaning: "眼光長遠，想得周到。", example: "這項計畫顯示了決策者____的眼光。", synonyms: ["深謀遠慮"], antonyms: ["鼠目寸光"] },
          { set: 5, word: "馬到成功", zhuyin: "ㄇㄚˇ ㄉㄠˋ ㄔㄥˊ ㄍㄨㄥ", meaning: "事情進行很順利、很快成功。", example: "祝你這次考試____！", synonyms: ["旗開得勝"], antonyms: ["屢戰屢敗"] },
          { set: 5, word: "胸有成竹", zhuyin: "ㄒㄩㄥ ㄧㄡˇ ㄔㄥˊ ㄓㄨˊ", meaning: "做事前已有完整計畫。", example: "對於這次比賽，他早已____。", synonyms: ["信心十足"], antonyms: ["手足無措"] },
          { set: 5, word: "推陳出新", zhuyin: "ㄊㄨㄟ ㄔㄣˊ ㄔㄨ ㄒㄧㄣ", meaning: "去舊創新，提出新想法。", example: "這家店不斷____，吸引許多顧客。", synonyms: ["除舊布新"], antonyms: ["墨守成規"] },
          { set: 5, word: "破釜沉舟", zhuyin: "ㄆㄛˋ ㄈㄨˇ ㄔㄣˊ ㄓㄡ", meaning: "下定決心不留退路。", example: "這次決賽，隊員們抱著____的決心。", synonyms: ["背水一戰"], antonyms: ["優柔寡斷"] },

          // --- Set 6 (11-12 畫) ---
          { set: 6, word: "得心應手", zhuyin: "ㄉㄜˊ ㄒㄧㄣ ㄧㄥˋ ㄕㄡˇ", meaning: "做起來很順手、很熟練。", example: "他操作機器已經____。", synonyms: ["駕輕就熟"], antonyms: ["手忙腳亂"] },
          { set: 6, word: "情不自禁", zhuyin: "ㄑㄧㄥˊ ㄅㄨˋ ㄗˋ ㄐㄧㄣ", meaning: "控制不住自己的情感。", example: "聽到感人的故事，他____流下眼淚。", synonyms: ["不由自主"], antonyms: ["無動於衷"] },
          { set: 6, word: "頂天立地", zhuyin: "ㄉㄧㄥˇ ㄊㄧㄢ ㄌㄧˋ ㄉㄧˋ", meaning: "做人正直、有擔當。", example: "做人要____，無愧於心。", synonyms: ["光明磊落"], antonyms: ["卑躬屈膝"] },
          { set: 6, word: "喜出望外", zhuyin: "ㄒㄧˇ ㄔㄨ ㄨㄤˋ ㄨㄞˋ", meaning: "高興得出乎意料。", example: "收到遠方朋友的禮物，讓他____。", synonyms: ["大喜過望"], antonyms: ["大失所望"] },
          { set: 6, word: "揚眉吐氣", zhuyin: "ㄧㄤˊ ㄇㄟˊ ㄊㄨˇ ㄑㄧˋ", meaning: "擺脫委屈，覺得痛快。", example: "苦練多年，他終於在比賽中奪冠，____。", synonyms: ["意氣風發"], antonyms: ["垂頭喪氣"] },
          { set: 6, word: "國色天香", zhuyin: "ㄍㄨㄛˊ ㄙㄜˋ ㄊㄧㄢ ㄒㄧㄤ", meaning: "形容非常美麗出眾。", example: "牡丹花被譽為____，花中之王。", synonyms: ["沉魚落雁"], antonyms: ["其貌不揚"] },
          { set: 6, word: "提心吊膽", zhuyin: "ㄊㄧˊ ㄒㄧㄣ ㄉㄧㄠˋ ㄉㄢˇ", meaning: "非常擔心害怕。", example: "走在漆黑的巷子裡，令人____。", synonyms: ["膽戰心驚"], antonyms: ["心安理得"] },
          { set: 6, word: "得過且過", zhuyin: "ㄉㄜˊ ㄍㄨㄛˋ ㄑㄧㄝˇ ㄍㄨㄛˋ", meaning: "只求過得去，不求進步。", example: "年輕人要有理想，不能____。", synonyms: ["敷衍塞責"], antonyms: ["精益求精"] },
          { set: 6, word: "畫龍點睛", zhuyin: "ㄏㄨㄚˋ ㄌㄨㄥˊ ㄉㄧㄢˇ ㄐㄧㄥ", meaning: "在關鍵處加一筆使更精彩。", example: "這個結尾真是____，讓整篇文章更出色。", synonyms: ["錦上添花"], antonyms: ["畫蛇添足"] },
          { set: 6, word: "忍氣吞聲", zhuyin: "ㄖㄣˇ ㄑㄧˋ ㄊㄨㄣ ㄕㄥ", meaning: "受委屈而忍著不說。", example: "為了顧全大局，他只好____。", synonyms: ["委曲求全"], antonyms: ["據理力爭"] },
          { set: 6, word: "呆若木雞", zhuyin: "ㄉㄞ ㄖㄨㄛˋ ㄇㄨˋ ㄐㄧ", meaning: "愣住不動，像木頭雞。", example: "聽到這個消息，他驚訝得____。", synonyms: ["目瞪口呆"], antonyms: ["神采飛揚"] },
          { set: 6, word: "坐吃山空", zhuyin: "ㄗㄨㄛˋ ㄔ ㄕㄢ ㄎㄨㄥ", meaning: "只花不賺，終會用盡。", example: "如果不工作只花錢，金山銀山也會____。", synonyms: ["坐享其成"], antonyms: ["開源節流"] },
          { set: 6, word: "束手無策", zhuyin: "ㄕㄨˋ ㄕㄡˇ ㄨˊ ㄘㄜˋ", meaning: "一點辦法也沒有。", example: "面對這個難題，大家一時____。", synonyms: ["無計可施"], antonyms: ["足智多謀"] },
          { set: 6, word: "自相矛盾", zhuyin: "ㄗˋ ㄒㄧㄤ ㄇㄠˊ ㄉㄨㄣˋ", meaning: "前後說法互相衝突。", example: "你的說法____，讓人無法相信。", synonyms: ["漏洞百出"], antonyms: ["自圓其說"] },
          { set: 6, word: "忙裡偷閒", zhuyin: "ㄇㄤˊ ㄌㄧˇ ㄊㄡ ㄒㄧㄢˊ", meaning: "很忙還抽空休息。", example: "他在繁忙的工作中____，喝了杯咖啡。", synonyms: ["苦中作樂"], antonyms: [] },
          { set: 6, word: "因禍得福", zhuyin: "ㄧㄣ ㄏㄨㄛˋ ㄉㄜˊ ㄈㄨˊ", meaning: "壞事反而帶來好結果。", example: "雖然生病住院，但他____，戒掉了菸酒。", synonyms: ["塞翁失馬"], antonyms: ["樂極生悲"] },

          // --- Set 7 (13-14 畫) ---
          { set: 7, word: "無微不至", zhuyin: "ㄨˊ ㄨㄟˊ ㄅㄨˋ ㄓˋ", meaning: "照顧得非常周到細心。", example: "父母對我們的照顧真是____。", synonyms: ["無微不至"], antonyms: ["漠不關心"] },
          { set: 7, word: "源遠流長", zhuyin: "ㄩㄢˊ ㄩㄢˇ ㄌㄧㄡˊ ㄔㄤˊ", meaning: "來源久遠、流傳很久。", example: "中華文化____，博大精深。", synonyms: ["根深蒂固"], antonyms: ["曇花一現"] },
          { set: 7, word: "義不容辭", zhuyin: "ㄧˋ ㄅㄨˋ ㄖㄨㄥˊ ㄘˊ", meaning: "道義上不能推辭。", example: "朋友有難，我____一定要幫忙。", synonyms: ["當仁不讓"], antonyms: ["推三阻四"] },
          { set: 7, word: "樂此不疲", zhuyin: "ㄌㄜˋ ㄘˇ ㄅㄨˋ ㄆㄧˊ", meaning: "做某事很樂意，不覺得累。", example: "他對集郵____，收藏了許多珍品。", synonyms: ["樂在其中"], antonyms: ["心生厭倦"] },
          { set: 7, word: "溫故知新", zhuyin: "ㄨㄣ ㄍㄨˋ ㄓ ㄒㄧㄣ", meaning: "複習舊知識得到新理解。", example: "學習要____，才能融會貫通。", synonyms: [], antonyms: [] },
          { set: 7, word: "順其自然", zhuyin: "ㄕㄨㄣˋ ㄑㄧˊ ㄗˋ ㄖㄢˊ", meaning: "按自然發展，不勉強。", example: "有些事強求不來，不如____。", synonyms: ["聽天由命"], antonyms: ["揠苗助長"] },
          { set: 7, word: "睹物思人", zhuyin: "ㄉㄨˇ ㄨˋ ㄙ ㄖㄣˊ", meaning: "看到物品就想起某人。", example: "看著這張舊照片，不禁讓人____。", synonyms: ["觸景生情"], antonyms: ["無動於衷"] },
          { set: 7, word: "勤能補拙", zhuyin: "ㄑㄧㄣˊ ㄋㄥˊ ㄅㄨˇ ㄓㄨㄛˊ", meaning: "勤奮可以彌補不足。", example: "雖然他不聰明，但相信____，終會成功。", synonyms: ["人一己百"], antonyms: [] },
          { set: 7, word: "舉足輕重", zhuyin: "ㄐㄩˇ ㄗㄨˊ ㄑㄧㄥ ㄓㄨㄥˋ", meaning: "影響力很大，地位重要。", example: "他在公司擔任____的角色。", synonyms: ["舉足輕重"], antonyms: ["無足輕重"] },
          { set: 7, word: "滴水穿石", zhuyin: "ㄉㄧ ㄕㄨㄟˇ ㄔㄨㄢ ㄕˊ", meaning: "持之以恆終能成功。", example: "只要有____的精神，再難的事也能完成。", synonyms: ["鐵杵磨針"], antonyms: ["半途而廢"] },
          { set: 7, word: "精益求精", zhuyin: "ㄐㄧㄥ ㄧˋ ㄑㄧㄡˊ ㄐㄧㄥ", meaning: "已很好還要更好。", example: "他的技術已經很好，但仍____。", synonyms: ["好上加好"], antonyms: ["得過且過"] },
          { set: 7, word: "聚精會神", zhuyin: "ㄐㄩˋ ㄐㄧㄥ ㄏㄨㄟˋ ㄕㄣˊ", meaning: "非常專注。", example: "同學們____地聽老師講課。", synonyms: ["全神貫注"], antonyms: ["心不在焉"] },
          { set: 7, word: "漫不經心", zhuyin: "ㄇㄢˋ ㄅㄨˋ ㄐㄧㄥ ㄒㄧㄣ", meaning: "不在意、不專心。", example: "他工作____，常出差錯。", synonyms: ["心不在焉"], antonyms: ["全神貫注"] },
          { set: 7, word: "謙虛謹慎", zhuyin: "ㄑㄧㄢ ㄒㄩ ㄐㄧㄣˇ ㄕㄣˋ", meaning: "不自滿，做事小心。", example: "做人要____，才能不斷進步。", synonyms: ["虛懷若谷"], antonyms: ["驕傲自大"] },
          { set: 7, word: "輕而易舉", zhuyin: "ㄑㄧㄥ ㄦˊ ㄧˋ ㄐㄩˇ", meaning: "非常容易做到。", example: "這件事對他來說____。", synonyms: ["易如反掌"], antonyms: ["難如登天"] },
          { set: 7, word: "銘記在心", zhuyin: "ㄇㄧㄥˊ ㄐㄧˋ ㄗㄞˋ ㄒㄧㄣ", meaning: "牢牢記住在心裡。", example: "老師的教誨，我會____。", synonyms: ["刻骨銘心"], antonyms: ["過眼雲煙"] },

          // --- Set 8 (15 畫及以上) ---
          { set: 8, word: "舉一反三", zhuyin: "ㄐㄩˇ ㄧ ㄈㄢˇ ㄙㄢ", meaning: "由一個例子推想到更多。", example: "讀書要能____，靈活運用。", synonyms: ["觸類旁通"], antonyms: ["囫圇吞棗"] },
          { set: 8, word: "學以致用", zhuyin: "ㄒㄩㄝˊ ㄧˇ ㄓˋ ㄩㄥˋ", meaning: "把學到的用在生活中。", example: "學習的目的在於____，解決實際問題。", synonyms: ["身體力行"], antonyms: ["紙上談兵"] },
          { set: 8, word: "腳踏實地", zhuyin: "ㄐㄧㄠˇ ㄊㄚˋ ㄕˊ ㄉㄧˋ", meaning: "做事務實，不浮誇。", example: "做人要____，一步一腳印。", synonyms: ["實事求是"], antonyms: ["好高騖遠"] },
          { set: 8, word: "鍥而不捨", zhuyin: "ㄑㄧㄝˋ ㄦˊ ㄅㄨˋ ㄕㄜˇ", meaning: "堅持到底不放棄。", example: "科學家憑著____的精神，終於發明新藥。", synonyms: ["持之以恆"], antonyms: ["半途而廢"] },
          { set: 8, word: "融會貫通", zhuyin: "ㄖㄨㄥˊ ㄏㄨㄟˋ ㄍㄨㄢˋ ㄊㄨㄥ", meaning: "把知識理解並能靈活運用。", example: "把各科知識____，才能學得更好。", synonyms: ["觸類旁通"], antonyms: ["一知半解"] },
          { set: 8, word: "循序漸進", zhuyin: "ㄒㄩㄣˊ ㄒㄩˋ ㄐㄧㄢˋ ㄐㄧㄣˋ", meaning: "按步驟慢慢前進。", example: "學習要____，不能急於求成。", synonyms: ["按部就班"], antonyms: ["揠苗助長"] },
          { set: 8, word: "適得其所", zhuyin: "ㄕˋ ㄉㄜˊ ㄑㄧˊ ㄙㄨㄛˇ", meaning: "安排得很恰當。", example: "這筆捐款用在需要的人身上，真是____。", synonyms: ["恰如其分"], antonyms: [] },
          { set: 8, word: "興高采烈", zhuyin: "ㄒㄧㄥˋ ㄍㄠ ㄘㄞˇ ㄌㄧㄝˋ", meaning: "非常高興、情緒高昂。", example: "孩子們____地去校外教學。", synonyms: ["歡天喜地"], antonyms: ["愁眉苦臉"] },
        ];

        // --- 3. 狀態與歷史紀錄 ---
        let savedHistory = [];
        try {
            const loaded = localStorage.getItem('idiom_history_sessions_chen');
            if(loaded) savedHistory = JSON.parse(loaded);
        } catch(e) { console.log('No history found'); }

        let state = {
            view: 'home', 
            currentSet: 1,
            activityType: 'learn', 
            currentIndex: 0,
            score: 0,
            
            currentSessionLog: [], 
            history: savedHistory, 
            selectedSession: null, 

            studentName: '陳以婷',
            scriptUrl: 'https://script.google.com/macros/s/AKfycbyoFfvC-xeLlAcfG2uI-cGUdm7YFVKJyGO7NEiekYOYIWJLEMDUBPIh83QjKwHQyJjs-g/exec',
            feedback: null, 
            isSubmitting: false,
            submitStatus: null
        };

        // --- 4. 輔助函式 ---
        
        function getSetData() {
            return idiomDatabase.filter(item => item.set === state.currentSet);
        }

        function clearHistory() {
            if(confirm('確定要清除所有作答記錄嗎？')) {
                localStorage.removeItem('idiom_history_sessions_chen');
                updateState({ history: [] });
            }
        }

        function getModeName(mode) {
            const map = {
                'learn': '成語學習',
                'quiz_meaning': '選出正確答案',
                'quiz_synonym_antonym': '相似/相反詞',
                'fill_blank': '靈活運用',
                'comprehensive': '綜合大測驗'
            };
            return map[mode] || mode;
        }

        function updateState(updates) {
            state = { ...state, ...updates };
            render();
        }

        function handleStart() {
            updateState({ view: 'sets' });
        }

        function startPractice(type) {
            updateState({
                activityType: type,
                currentIndex: 0,
                score: 0,
                currentSessionLog: [],
                feedback: null,
                submitStatus: null,
                view: 'practice'
            });
        }

        function getDistractors(excludeWord, count) {
            const allWords = idiomDatabase.map(q => q.word);
            const others = allWords.filter(w => w !== excludeWord);
            return others.sort(() => Math.random() - 0.5).slice(0, count);
        }

        function handleAnswer(selectedOption, correctOption, questionData, questionText) {
            const isCorrect = selectedOption === correctOption;
            
            const logEntry = {
                question: questionText || questionData.word,
                userAnswer: selectedOption,
                correctAnswer: correctOption,
                isCorrect: isCorrect
            };

            const newLog = [...state.currentSessionLog, logEntry];
            let newScore = state.score;
            if (isCorrect) newScore += 10;

            updateState({ 
                feedback: isCorrect ? 'correct' : 'wrong',
                score: newScore,
                currentSessionLog: newLog
            });

            setTimeout(() => {
                const questions = getSetData();
                if (state.currentIndex < questions.length - 1) {
                    updateState({ 
                        feedback: null, 
                        currentIndex: state.currentIndex + 1 
                    });
                } else {
                    finishSession(newLog, newScore, questions.length);
                }
            }, 1500);
        }

        function finishSession(logs, finalScore, totalQ) {
            const newSession = {
                id: Date.now(),
                timestamp: new Date().toISOString(),
                set: state.currentSet,
                mode: state.activityType,
                score: finalScore,
                totalQuestions: totalQ * 10,
                questionCount: totalQ, // Store count separately
                logs: logs
            };

            const newHistory = [newSession, ...state.history];
            localStorage.setItem('idiom_history_sessions_chen', JSON.stringify(newHistory));

            updateState({ 
                feedback: null, 
                history: newHistory,
                view: 'result' 
            });
        }

        // 修改：統一的上傳邏輯，支援上傳歷史紀錄
        async function submitToGoogle(sessionData = null) {
            if (!state.scriptUrl) {
                alert("請先設定 Google Apps Script 網址！");
                return;
            }
            updateState({ isSubmitting: true });

            // 決定要上傳哪一份資料 (當前練習 or 歷史紀錄)
            const isHistoryUpload = !!sessionData;
            
            // 如果是歷史紀錄，使用傳入的 sessionData
            // 如果是當前練習，構造一個臨時的 session 對象 (因為還沒存入 history 或者是剛存入)
            // 其實 finishSession 已經存入 history 了，state.history[0] 就是最新的
            // 但為了保險，我們直接使用 currentSessionLog 來構造當下的資料
            
            const targetSet = sessionData ? sessionData.set : state.currentSet;
            const targetMode = sessionData ? sessionData.mode : state.activityType;
            const targetScore = sessionData ? sessionData.score : state.score;
            // 總題數邏輯：歷史紀錄有 questionCount 則用之，否則用總分/10，再否則重新計算
            const targetTotalQ = sessionData ? (sessionData.questionCount || sessionData.totalQuestions / 10) : getSetData().length; 
            const targetLogs = sessionData ? sessionData.logs : state.currentSessionLog;
            const targetTimestamp = sessionData ? new Date(sessionData.timestamp).toLocaleString() : new Date().toLocaleString();

            // 格式化詳情字串 (Spreadsheet Friendly Format)
            const formattedDetails = targetLogs.map((log, i) => {
                const resultIcon = log.isCorrect ? '⭕' : '❌';
                let line = `${i+1}. ${resultIcon} ${log.question}`;
                if (!log.isCorrect) {
                    line += ` (誤: ${log.userAnswer} | 正: ${log.correctAnswer})`;
                }
                return line;
            }).join('\n');

            const payload = {
                studentName: state.studentName,
                set: targetSet,
                mode: targetMode,
                score: targetScore,
                totalQuestions: targetTotalQ, // 傳送題數
                timestamp: targetTimestamp,
                details: formattedDetails // 傳送格式化後的字串
            };

            try {
                await fetch(state.scriptUrl, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if(isHistoryUpload) {
                    alert("歷史紀錄補上傳成功！");
                    updateState({ isSubmitting: false });
                } else {
                    updateState({ isSubmitting: false, submitStatus: 'success' });
                }
                
            } catch (error) {
                console.error(error);
                if(isHistoryUpload) {
                    alert("上傳失敗，請檢查網路。");
                    updateState({ isSubmitting: false });
                } else {
                    updateState({ isSubmitting: false, submitStatus: 'error' });
                }
            }
        }

        // --- 6. 渲染函式 (Render Views) ---

        function render() {
            const app = document.getElementById('app');
            app.innerHTML = ''; 

            switch (state.view) {
                case 'home': app.appendChild(renderHome()); break;
                case 'sets': app.appendChild(renderSets()); break;
                case 'activities': app.appendChild(renderActivities()); break;
                case 'practice': app.appendChild(renderPractice()); break;
                case 'result': app.appendChild(renderResult()); break;
                case 'history': app.appendChild(renderHistory()); break;
                case 'history_detail': app.appendChild(renderHistoryDetail()); break;
                default: app.appendChild(renderHome());
            }
        }

        function renderHome() {
            const div = document.createElement('div');
            div.className = "flex flex-col items-center justify-center h-full flex-grow space-y-8 p-6 bg-gradient-to-b from-pink-100 to-blue-50";
            div.innerHTML = `
                <div class="text-center space-y-2">
                    <h1 class="text-4xl md:text-5xl font-black text-pink-600 tracking-wider drop-shadow-sm">陳以婷的<br>成語探險家</h1>
                    <div class="text-xl text-gray-600 font-bold">國小五年級 - 專屬練習平台</div>
                </div>
                <div class="bg-white p-6 rounded-3xl shadow-xl w-full max-w-md border-4 border-pink-200">
                    <label class="block text-gray-500 font-bold mb-2 text-sm uppercase tracking-wide">挑戰者</label>
                    <div class="w-full p-4 bg-gray-100 rounded-xl text-2xl font-black text-gray-700 text-center select-none">${state.studentName}</div>
                </div>
                <div class="flex flex-col gap-4 w-full max-w-md">
                    <button onclick="updateState({view: 'sets'})" class="w-full px-8 py-5 bg-gradient-to-r from-pink-500 to-rose-500 hover:from-pink-600 hover:to-rose-600 text-white text-2xl font-black rounded-2xl shadow-lg transform transition hover:scale-105 flex items-center justify-center gap-3 btn-hover">開始冒險 ${Icons.ChevronRight}</button>
                    <button onclick="updateState({view: 'history'})" class="w-full px-8 py-4 bg-white text-pink-600 border-2 border-pink-200 hover:bg-pink-50 text-xl font-bold rounded-2xl shadow-sm transition flex items-center justify-center gap-2 btn-hover">${Icons.Clipboard} 查看我的作答記錄</button>
                </div>
                <div class="mt-8 text-xs text-gray-400 w-full max-w-md text-center">
                    <details>
                        <summary>老師設定</summary>
                        <input id="urlInput" type="text" class="w-full p-2 border mt-2 rounded" placeholder="Apps Script URL" value="${state.scriptUrl}">
                    </details>
                </div>
            `;
            div.querySelector('#urlInput').addEventListener('input', (e) => state.scriptUrl = e.target.value);
            return div;
        }

        function renderSets() {
            const div = document.createElement('div');
            div.className = "p-6 bg-blue-50 min-h-screen";
            const setInfo = [
                { num: 1, range: "1-2 畫" }, { num: 2, range: "3-4 畫" }, { num: 3, range: "5-6 畫" }, { num: 4, range: "7-8 畫" },
                { num: 5, range: "9-10 畫" }, { num: 6, range: "11-12 畫" }, { num: 7, range: "13-14 畫" }, { num: 8, range: "15 畫及以上" }
            ];
            let buttonsHtml = '';
            setInfo.forEach(info => {
                buttonsHtml += `
                    <button onclick="selectSet(${info.num})" class="h-40 bg-white rounded-2xl shadow-md hover:shadow-xl hover:bg-blue-50 transition border-b-4 border-blue-200 hover:border-blue-400 flex flex-col items-center justify-center gap-2 btn-hover group">
                        <span class="text-4xl font-black text-blue-300 group-hover:text-blue-500 transition">0${info.num}</span>
                        <span class="text-xl font-bold text-gray-700">第 ${info.num} 關</span>
                        <span class="text-sm text-gray-500">適合筆畫: ${info.range}</span>
                    </button>
                `;
            });
            div.innerHTML = `
                <button onclick="updateState({view: 'home'})" class="mb-4 text-blue-500 font-bold flex items-center hover:bg-blue-100 px-4 py-2 rounded-lg transition">← 回首頁</button>
                <h2 class="text-3xl font-bold text-center text-blue-800 mb-8">選擇挑戰關卡</h2>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-6 max-w-5xl mx-auto">${buttonsHtml}</div>
            `;
            return div;
        }
        window.selectSet = (setNum) => updateState({ currentSet: setNum, view: 'activities' });

        function renderActivities() {
            const div = document.createElement('div');
            div.className = "p-6 bg-indigo-50 min-h-screen flex flex-col items-center";
            const createCard = (icon, title, desc, color, type) => `
                <button onclick="window.appStartPractice('${type}')" class="p-6 rounded-2xl border-b-4 text-left transition hover:-translate-y-1 hover:shadow-lg flex items-start gap-4 ${color} w-full btn-hover">
                    <div class="p-2 bg-white bg-opacity-50 rounded-lg text-gray-800">${icon}</div>
                    <div><h3 class="text-xl font-bold mb-1">${title}</h3><p class="text-sm opacity-90">${desc}</p></div>
                </button>
            `;
            div.innerHTML = `
                <button onclick="updateState({view: 'sets'})" class="self-start mb-4 text-indigo-500 font-bold hover:bg-indigo-100 px-4 py-2 rounded-lg transition">← 回關卡選單</button>
                <h2 class="text-3xl font-bold text-indigo-800 mb-2">第 ${state.currentSet} 關：選擇模式</h2>
                <p class="text-gray-500 mb-8">準備好要挑戰什麼了嗎？</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 w-full max-w-3xl">
                    ${createCard(Icons.BookOpen, "成語解釋 (學習)", "先來認識這些成語的意思和注音吧！", "bg-green-100 text-green-700 border-green-300", 'learn')}
                    ${createCard(Icons.Star, "選出正確答案", "根據解釋，選出正確的成語。", "bg-yellow-100 text-yellow-700 border-yellow-300", 'quiz_meaning')}
                    ${createCard(Icons.ArrowLeftRight, "相似/相反詞挑戰", "這個成語跟誰意思相近或相反？", "bg-purple-100 text-purple-700 border-purple-300", 'quiz_synonym_antonym')}
                    ${createCard(Icons.Edit3, "靈活運用 (填空)", "讀例句，把適合的成語填進去。", "bg-pink-100 text-pink-700 border-pink-300", 'fill_blank')}
                    <div class="col-span-1 md:col-span-2">${createCard(Icons.Trophy, "綜合大測驗", "包含解釋、填空與相似相反詞題型！", "bg-blue-100 text-blue-700 border-blue-300", 'comprehensive')}</div>
                </div>
            `;
            return div;
        }
        window.appStartPractice = startPractice;

        function renderPractice() {
            const div = document.createElement('div');
            const questions = getSetData();
            const currentQ = questions[state.currentIndex];

            if (state.activityType === 'learn') {
                div.className = "flex flex-col items-center justify-center min-h-screen bg-green-50 p-6";
                div.innerHTML = `
                    <div class="bg-white rounded-3xl shadow-xl p-8 max-w-2xl w-full text-center relative overflow-hidden animate-fade-in border-b-8 border-green-200">
                        <div class="absolute top-0 left-0 w-full h-4 bg-green-400"></div>
                        <span class="text-gray-400 text-sm font-bold tracking-widest uppercase mb-2 block">Card ${state.currentIndex + 1} / ${questions.length}</span>
                        <h1 class="text-5xl md:text-6xl font-black text-gray-800 mb-4">${currentQ.word}</h1>
                        <div class="text-2xl md:text-3xl text-green-600 font-serif mb-8">${currentQ.zhuyin}</div>
                        <div class="bg-green-50 rounded-xl p-6 mb-4 text-left"><h3 class="font-bold text-green-800 mb-2">【解釋】</h3><p class="text-xl text-gray-700">${currentQ.meaning}</p></div>
                        <div class="bg-blue-50 rounded-xl p-6 text-left border-l-4 border-blue-400 mb-4"><h3 class="font-bold text-blue-800 mb-2">【例句】</h3><p class="text-lg text-gray-700">${currentQ.example.replace('____', currentQ.word)}</p></div>
                        <div class="grid grid-cols-2 gap-4 text-sm mb-8">
                            <div class="bg-purple-50 p-2 rounded text-purple-800 text-left"><span class="font-bold">相似詞：</span>${currentQ.synonyms?.length > 0 ? currentQ.synonyms.join("、") : "無"}</div>
                            <div class="bg-red-50 p-2 rounded text-red-800 text-left"><span class="font-bold">相反詞：</span>${currentQ.antonyms?.length > 0 ? currentQ.antonyms.join("、") : "無"}</div>
                        </div>
                        <div class="flex justify-between">
                            <button id="prevBtn" class="px-6 py-2 rounded-lg bg-gray-200 text-gray-600 disabled:opacity-50 font-bold hover:bg-gray-300 transition" ${state.currentIndex === 0 ? 'disabled' : ''}>上一個</button>
                            <button id="nextBtn" class="px-6 py-2 rounded-lg bg-green-500 text-white font-bold hover:bg-green-600 btn-hover transition">${state.currentIndex < questions.length - 1 ? '下一個' : '完成學習'}</button>
                        </div>
                    </div>
                `;
                div.querySelector('#prevBtn').onclick = () => updateState({ currentIndex: state.currentIndex - 1 });
                div.querySelector('#nextBtn').onclick = () => {
                    if (state.currentIndex < questions.length - 1) updateState({ currentIndex: state.currentIndex + 1 });
                    else updateState({ view: 'activities' });
                };
                return div;
            }

            div.className = "flex flex-col items-center min-h-screen bg-yellow-50 p-4";
            let questionText = "", options = [], correctAnswer = "";
            const generateOptions = (answer) => {
                const distractors = getDistractors(answer, 3);
                return [answer, ...distractors].sort(() => Math.random() - 0.5);
            };

            if (state.activityType === 'quiz_meaning') {
                questionText = `「${currentQ.meaning}」 是哪一個成語？`;
                correctAnswer = currentQ.word;
                options = generateOptions(correctAnswer);
            } else if (state.activityType === 'fill_blank') {
                questionText = currentQ.example;
                correctAnswer = currentQ.word;
                options = generateOptions(correctAnswer);
            } else {
                const hasSyn = currentQ.synonyms?.length > 0;
                const hasAnt = currentQ.antonyms?.length > 0;
                let type = 'syn';
                if (hasSyn && hasAnt) type = Math.random() > 0.5 ? 'syn' : 'ant';
                else if (hasAnt) type = 'ant';
                else if (!hasSyn && !hasAnt) { questionText = `「${currentQ.meaning}」 是哪一個成語？`; correctAnswer = currentQ.word; options = generateOptions(correctAnswer); }
                
                if (state.activityType === 'quiz_synonym_antonym' || (state.activityType === 'comprehensive' && (state.currentIndex + state.score) % 3 === 2)) {
                    if (type === 'syn') { correctAnswer = currentQ.synonyms[0]; questionText = `下列哪一個是「${currentQ.word}」的相似詞？`; } 
                    else { correctAnswer = currentQ.antonyms[0]; questionText = `下列哪一個是「${currentQ.word}」的相反詞？`; }
                    options = generateOptions(correctAnswer);
                } else if (state.activityType === 'comprehensive') {
                    if ((state.currentIndex + state.score) % 3 === 0) { questionText = `「${currentQ.meaning}」 是哪一個成語？`; correctAnswer = currentQ.word; }
                    else { questionText = currentQ.example; correctAnswer = currentQ.word; }
                    options = generateOptions(correctAnswer);
                }
            }

            const progress = ((state.currentIndex) / questions.length) * 100;
            let feedbackOverlay = '';
            if (state.feedback === 'correct') {
                feedbackOverlay = `<div class="absolute inset-0 bg-green-100 bg-opacity-95 rounded-2xl flex flex-col items-center justify-center z-10 animate-fade-in backdrop-blur-sm"><div class="text-green-500 scale-110">${Icons.CheckCircle}</div><span class="text-4xl font-black text-green-600 mt-4">答對了！</span></div>`;
            } else if (state.feedback === 'wrong') {
                feedbackOverlay = `<div class="absolute inset-0 bg-red-100 bg-opacity-95 rounded-2xl flex flex-col items-center justify-center z-10 animate-fade-in backdrop-blur-sm"><div class="text-red-500 scale-110">${Icons.XCircle}</div><span class="text-4xl font-black text-red-600 mt-4">再試一次！</span><div class="mt-4 p-4 bg-white rounded-xl shadow-lg"><span class="block text-gray-500 text-sm font-bold uppercase">正確答案</span><span class="text-2xl font-bold text-red-600">${correctAnswer}</span></div></div>`;
            }

            let optionsHtml = options.map(opt => `<button onclick="window.appHandleAnswer('${opt}', '${correctAnswer}', '${encodeURIComponent(JSON.stringify(currentQ))}', '${encodeURIComponent(questionText)}')" class="p-4 rounded-xl border-2 border-gray-100 bg-white hover:bg-yellow-100 hover:border-yellow-300 text-xl font-bold text-gray-700 transition active:scale-95 btn-hover shadow-sm">${opt}</button>`).join('');

            div.innerHTML = `
                <div class="w-full max-w-2xl h-4 bg-gray-200 rounded-full mb-6 overflow-hidden"><div class="h-full bg-yellow-400 transition-all duration-500 ease-out" style="width: ${progress}%"></div></div>
                <div class="bg-white rounded-2xl shadow-xl p-8 max-w-2xl w-full text-center relative min-h-[400px] flex flex-col justify-center border-b-8 border-gray-100">${feedbackOverlay}<h2 class="text-lg text-gray-500 font-bold mb-6 flex items-center justify-center gap-2">題目 ${state.currentIndex + 1} / ${questions.length} ${state.activityType === 'comprehensive' ? '<span class="bg-blue-100 text-blue-600 text-xs px-2 py-1 rounded">綜合挑戰</span>' : ''}</h2><div class="text-2xl font-bold text-gray-800 mb-10 leading-relaxed min-h-[100px] flex items-center justify-center px-4">${questionText}</div><div class="grid grid-cols-1 md:grid-cols-2 gap-4 w-full">${optionsHtml}</div></div>
                <div class="mt-8 text-xl font-bold text-yellow-600 bg-yellow-50 px-6 py-2 rounded-full">目前分數：${state.score}</div>
            `;
            return div;
        }
        window.appHandleAnswer = (sel, cor, qDataStr, qTextStr) => {
            const qData = JSON.parse(decodeURIComponent(qDataStr));
            const qText = decodeURIComponent(qTextStr);
            handleAnswer(sel, cor, qData, qText);
        }

        function renderResult() {
            const div = document.createElement('div');
            div.className = "flex flex-col items-center justify-center min-h-screen bg-purple-50 p-6";
            const submitBtnContent = state.isSubmitting ? `<span class="animate-spin mr-2">${Icons.Refresh}</span> 處理中...` : (state.submitStatus === 'success' ? `${Icons.CheckCircle} 成績已上傳` : `${Icons.Save} 上傳成績給老師`);
            const btnClass = state.submitStatus === 'success' ? 'bg-green-500 text-white cursor-default' : 'bg-blue-600 text-white hover:bg-blue-700 shadow-lg hover:shadow-xl';

            div.innerHTML = `
                <div class="bg-white p-10 rounded-3xl shadow-2xl text-center max-w-lg w-full animate-fade-in border-4 border-purple-100">
                    <div class="text-yellow-400 mx-auto w-20 mb-6">${Icons.Trophy}</div>
                    <h2 class="text-4xl font-black text-gray-800 mb-2">練習完成！</h2>
                    <p class="text-xl text-gray-500 mb-8">${state.studentName}，做得好！</p>
                    <div class="bg-purple-100 rounded-xl p-6 mb-8"><span class="block text-sm text-purple-600 font-bold uppercase tracking-wider">本局得分</span><span class="text-6xl font-black text-purple-700">${state.score}</span><span class="text-purple-400 text-xl"> / ${getSetData().length * 10} 分</span></div>
                    <div class="space-y-3">
                        <button onclick="window.submitToGoogle()" id="submitBtn" class="w-full py-4 rounded-xl font-bold text-xl flex items-center justify-center gap-2 transition ${btnClass}" ${state.submitStatus === 'success' ? 'disabled' : ''}>${submitBtnContent}</button>
                        <button onclick="updateState({view: 'history'})" class="w-full py-4 rounded-xl font-bold text-xl text-pink-600 bg-pink-50 hover:bg-pink-100 transition flex items-center justify-center gap-2">${Icons.Clipboard} 查看作答記錄</button>
                        <button onclick="updateState({view: 'sets'})" class="w-full py-4 rounded-xl font-bold text-xl text-gray-600 bg-gray-100 hover:bg-gray-200 transition">練習其他關卡</button>
                    </div>
                </div>
            `;
            return div;
        }
        window.submitToGoogle = submitToGoogle;

        function renderHistory() {
            const div = document.createElement('div');
            div.className = "p-6 bg-gray-50 min-h-screen";

            if (!state.history || state.history.length === 0) {
                 div.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-screen">
                        <h2 class="text-2xl font-bold text-gray-400 mb-4">目前沒有紀錄</h2>
                        <button onclick="updateState({view: 'home'})" class="px-6 py-2 bg-blue-500 text-white rounded-full">回首頁</button>
                    </div>
                 `;
                 return div;
            }

            let cardsHtml = state.history.map(session => {
                const date = new Date(session.timestamp);
                const dateStr = `${date.getMonth()+1}/${date.getDate()} ${String(date.getHours()).padStart(2,'0')}:${String(date.getMinutes()).padStart(2,'0')}`;
                const modeName = getModeName(session.mode);
                const colorClass = session.score === session.totalQuestions ? 'border-yellow-400 bg-yellow-50' : 'border-gray-200 bg-white';

                return `
                    <button onclick="window.showSessionDetail(${session.id})" class="text-left w-full p-4 rounded-2xl shadow-sm hover:shadow-md transition border-l-8 ${colorClass} flex flex-col justify-between h-32 relative group">
                        <div class="flex justify-between items-start w-full">
                            <div>
                                <span class="text-xs font-bold text-gray-400 uppercase">${dateStr}</span>
                                <div class="text-2xl font-black text-gray-800 group-hover:text-blue-600">第 ${session.set} 關</div>
                                <div class="text-sm text-gray-500">${modeName}</div>
                            </div>
                            <div class="text-right">
                                <div class="text-3xl font-black ${session.score === session.totalQuestions ? 'text-yellow-600' : 'text-blue-600'}">${session.score}</div>
                                <div class="text-xs text-gray-400">分</div>
                            </div>
                        </div>
                        <div class="absolute bottom-4 right-4 opacity-0 group-hover:opacity-100 transition text-blue-400">${Icons.Eye}</div>
                    </button>
                `;
            }).join('');

            div.innerHTML = `
                <div class="max-w-5xl mx-auto">
                    <div class="flex justify-between items-center mb-8 sticky top-0 bg-gray-50 py-4 z-10">
                        <button onclick="updateState({view: 'home'})" class="bg-white px-4 py-2 rounded-full shadow text-gray-600 font-bold hover:bg-gray-100">← 回首頁</button>
                        <h2 class="text-2xl font-bold text-gray-800">我的冒險日誌</h2>
                        <button onclick="clearHistory()" class="text-red-300 hover:text-red-500 p-2" title="清除所有紀錄">${Icons.Trash}</button>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">${cardsHtml}</div>
                </div>
            `;
            return div;
        }

        window.showSessionDetail = (id) => {
            const session = state.history.find(s => s.id === id);
            updateState({ selectedSession: session, view: 'history_detail' });
        }

        // --- History Detail View (包含補上傳功能) ---
        function renderHistoryDetail() {
            const session = state.selectedSession;
            const div = document.createElement('div');
            div.className = "flex flex-col items-center min-h-screen bg-gray-50 p-6";

            if (!session) return renderHistory();

            const date = new Date(session.timestamp);
            const timeStr = `${date.getFullYear()}/${date.getMonth()+1}/${date.getDate()} ${String(date.getHours()).padStart(2,'0')}:${String(date.getMinutes()).padStart(2,'0')}`;

            let listHtml = session.logs.map((log, index) => {
                const isCorrect = log.isCorrect;
                return `
                    <div class="w-full max-w-2xl bg-white rounded-xl shadow-sm p-4 mb-3 border-l-4 ${isCorrect ? 'border-green-500' : 'border-red-500'} flex gap-4">
                        <div class="mt-1 flex-shrink-0 ${isCorrect ? 'text-green-500' : 'text-red-500'}">
                            ${isCorrect ? Icons.Check : Icons.X} 
                        </div>
                        <div class="flex-grow">
                            <div class="font-bold text-gray-800 text-lg mb-2">${log.question}</div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm bg-gray-50 p-2 rounded-lg">
                                <div><span class="text-gray-400 text-xs mr-2">你的答案</span><span class="${isCorrect ? 'text-green-700 font-bold' : 'text-red-500 line-through'}">${log.userAnswer}</span></div>
                                ${!isCorrect ? `<div><span class="text-gray-400 text-xs mr-2">正確答案</span><span class="text-green-600 font-bold">${log.correctAnswer}</span></div>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // 將 session 物件轉為 JSON 字串，放入 onclick 中
            const sessionJson = encodeURIComponent(JSON.stringify(session));

            div.innerHTML = `
                <div class="w-full max-w-2xl mb-6 flex items-center justify-between sticky top-0 bg-gray-50 py-4 z-10">
                    <button onclick="updateState({view: 'history'})" class="text-gray-500 font-bold flex items-center hover:text-gray-700 bg-white px-4 py-2 rounded-full shadow-sm transition">← 返回列表</button>
                    <h2 class="text-xl font-bold text-gray-800">第 ${session.set} 關詳情</h2>
                    <div class="w-10"></div>
                </div>

                <div class="w-full max-w-2xl bg-white rounded-2xl shadow-md p-6 mb-6 border border-gray-100">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <div class="text-sm text-gray-500">${timeStr}</div>
                            <div class="text-lg font-bold text-gray-800">${getModeName(session.mode)}</div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm text-gray-500">得分</div>
                            <div class="text-3xl font-black text-blue-600">${session.score} <span class="text-sm font-normal text-gray-400">/ ${session.totalQuestions}</span></div>
                        </div>
                    </div>
                    <button onclick='window.uploadHistorySession("${sessionJson}")' class="w-full py-2 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 font-bold flex items-center justify-center gap-2 transition text-sm">
                        ${Icons.CloudUpload} 補上傳至 Google 試算表
                    </button>
                </div>

                <div class="w-full max-w-2xl pb-10">
                    ${listHtml}
                </div>
            `;
            return div;
        }

        // Bridge function for uploading history
        window.uploadHistorySession = (sessionStr) => {
            const session = JSON.parse(decodeURIComponent(sessionStr));
            submitToGoogle(session);
        };

        render();
    </script>
</body>
</html>
